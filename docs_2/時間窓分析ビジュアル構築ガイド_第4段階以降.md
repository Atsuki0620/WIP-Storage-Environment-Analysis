# 時間窓分析ビジュアル構築ガイド：第4段階以降の詳細手順

## 目次

1. [実装の前提条件](#実装の前提条件)
2. [第4段階：リレーションシップの構築](#第4段階リレーションシップの構築)
3. [第5段階：散布図ビジュアルの作成](#第5段階散布図ビジュアルの作成)
4. [第6段階：相関分析メジャーと決定係数メジャーの作成](#第6段階相関分析メジャーと決定係数メジャーの作成)
5. [第7段階：時間窓別R²比較の縦棒グラフ作成](#第7段階時間窓別r²比較の縦棒グラフ作成)
6. [補足：集計可能ロット数の可視化](#補足集計可能ロット数の可視化)
7. [検証手順](#検証手順)

---

## 実装の前提条件

本ガイドは、第1段階から第3段階までの実装が完了していることを前提としています。具体的には、以下のテーブルとデータ構造が既に存在している必要があります。

計測ログテーブルについては、Cur_計測ログ_UF、Cur_計測ログ_RO、Cur_計測ログ_RTのそれぞれに、保管開始時刻列、経過時間_時間列、保管終了時刻列、終了前経過時間_時間列が追加されている必要があります。

ディメンションテーブルについては、Dim_時間窓マスタが作成されており、8行のデータ（生産直後4種類、使用直前4種類）が格納されている必要があります。

計算テーブルについては、Calc_UF保管統計_生産直後、Calc_UF保管統計_使用直前、Calc_RO保管統計_生産直後、Calc_RO保管統計_使用直前、Calc_RT保管統計_生産直後、Calc_RT保管統計_使用直前の6つのテーブルがDAXで作成されている必要があります。

ファクトテーブルについては、Cur_ロット系譜テーブルが存在し、製品ロット、RTロット、ROロット、UFロット、各種性能指標（性能F、性能R、RT性能F、RT性能R、RO性能F、RO性能R）の列が含まれている必要があります。

これらの前提条件が満たされていることを確認してから、第4段階以降の実装に進んでください。

---

## 第4段階：リレーションシップの構築

リレーションシップの構築は、データモデルの基盤となる重要な段階です。本段階では、合計14個のリレーションシップを構築します。これらは、時間窓マスタと計算テーブル間の6個、計算テーブルとロット系譜間の6個、計測ログとロット系譜間の2個から構成されます。

### リレーションシップグループ1：Dim_時間窓マスタと各計算テーブル

Dim_時間窓マスタは、すべての計算テーブルに対して一対多のリレーションシップを持ちます。時間窓スライサーで特定の時間窓を選択すると、すべての計算テーブルが同時にフィルタリングされるため、分析の一貫性が保たれます。

まず、Power BIのモデルビューを開きます。リボンメニューから「モデル」タブを選択し、画面上部の表示オプションで「モデルビュー」に切り替えます。モデルビュー画面では、既に作成されたテーブルがキャンバス上に配置されています。テーブルをドラッグして、視覚的に理解しやすい配置に整理することを推奨します。例えば、Dim_時間窓マスタを中央上部に配置し、その下に6つの計算テーブルを左右に並べ、さらにその下にCur_ロット系譜を配置するといったレイアウトが有効です。

Dim_時間窓マスタテーブルからCalc_UF保管統計_生産直後テーブルへのリレーションシップを作成します。Dim_時間窓マスタテーブルの時間窓ID列をクリックし、そのままマウスボタンを押したままCalc_UF保管統計_生産直後テーブルの時間窓ID列までドラッグします。マウスボタンを離すと、リレーションシップ編集ダイアログが表示されます。カーディナリティが自動的に一対多（1:*）に設定されていることを確認します。クロスフィルタ方向は単一（Single）のままとし、OKボタンをクリックしてリレーションシップを確定します。

同様の手順で、Dim_時間窓マスタから残りの5つの計算テーブルに対してもリレーションシップを作成します。具体的には、Dim_時間窓マスタ[時間窓ID]からCalc_UF保管統計_使用直前[時間窓ID]へのリレーションシップ、Dim_時間窓マスタ[時間窓ID]からCalc_RO保管統計_生産直後[時間窓ID]へのリレーションシップ、Dim_時間窓マスタ[時間窓ID]からCalc_RO保管統計_使用直前[時間窓ID]へのリレーションシップ、Dim_時間窓マスタ[時間窓ID]からCalc_RT保管統計_生産直後[時間窓ID]へのリレーションシップ、Dim_時間窓マスタ[時間窓ID]からCalc_RT保管統計_使用直前[時間窓ID]へのリレーションシップを作成します。すべてのリレーションシップにおいて、カーディナリティは一対多、クロスフィルタ方向は単一とします。

### リレーションシップグループ2：各計算テーブルとCur_ロット系譜

計算テーブルとCur_ロット系譜の間には多対多のリレーションシップを構築します。これは、同一のロット番号が計算テーブル側では複数の時間窓により繰り返され、Cur_ロット系譜側では複数の製品で使用されるためです。クロスフィルタ方向は双方向とすることで、どちらの方向からもフィルタリングが可能となります。

Calc_UF保管統計_生産直後テーブルのUFロット列からCur_ロット系譜テーブルのUFロット列へリレーションシップを作成します。リレーションシップ編集ダイアログが表示されたら、カーディナリティのドロップダウンから多対多（*:*）を選択します。クロスフィルタ方向のドロップダウンから双方向（Both）を選択します。このとき、Power BIから双方向フィルタリングに関する警告メッセージが表示される場合がありますが、本分析では双方向フィルタリングが必要であるため、適用をクリックして続行します。

同様の手順で、残りの5つの計算テーブルとCur_ロット系譜の間にもリレーションシップを作成します。Calc_UF保管統計_使用直前[UFロット]からCur_ロット系譜[UFロット]へのリレーションシップ、Calc_RO保管統計_生産直後[ROロット]からCur_ロット系譜[ROロット]へのリレーションシップ、Calc_RO保管統計_使用直前[ROロット]からCur_ロット系譜[ROロット]へのリレーションシップ、Calc_RT保管統計_生産直後[RTロット]からCur_ロット系譜[RTロット]へのリレーションシップ、Calc_RT保管統計_使用直前[RTロット]からCur_ロット系譜[RTロット]へのリレーションシップを作成します。すべてのリレーションシップにおいて、カーディナリティは多対多、クロスフィルタ方向は双方向とします。

### リレーションシップグループ3：計測ログとCur_ロット系譜（既存の確認）

計測ログテーブルとCur_ロット系譜の間のリレーションシップは、既にパターンA設計時に構築されている可能性があります。これらのリレーションシップが存在しない場合は、以下の手順で作成します。

Cur_計測ログ_UF[LOT]からCur_ロット系譜[UFロット]へのリレーションシップを作成します。カーディナリティは多対多、クロスフィルタ方向は双方向とします。同様に、Cur_計測ログ_RO[LOT]からCur_ロット系譜[ROロット]へのリレーションシップ、Cur_計測ログ_RT[LOT]からCur_ロット系譜[RTロット]へのリレーションシップを作成します。

これらのリレーションシップは、詳細な計測データを参照する際に使用されますが、本時間窓分析においては主要な分析パスではありません。主要な分析パスは、Dim_時間窓マスタから計算テーブルを経由してCur_ロット系譜に至るルートとなります。

### リレーションシップ構築の確認

すべてのリレーションシップの作成が完了したら、モデルビューで視覚的に確認します。Dim_時間窓マスタから6本の線が各計算テーブルに伸び、各計算テーブルからCur_ロット系譜へ線が伸びている構造が確認できるはずです。リレーションシップの線をクリックすると、そのリレーションシップの詳細がプロパティパネルに表示されます。カーディナリティとクロスフィルタ方向が正しく設定されているかを確認してください。

リレーションシップが正しく機能しているかを簡易的に確認するため、レポートビューに切り替え、Dim_時間窓マスタの時間窓名列をスライサーとして配置し、いずれかの計算テーブルからロット列と平均温度列を選択してテーブルビジュアルを作成します。スライサーで特定の時間窓を選択した際に、テーブルビジュアルのデータが適切にフィルタリングされることを確認します。

---

## 第5段階：散布図ビジュアルの作成

散布図は、保管条件と製品性能の相関関係を視覚的に検証するための中核的なビジュアルです。本段階では、分析対象ごとに散布図を作成し、トレンドラインを追加することで決定係数を表示します。

### 分析対象別レポートページの作成

分析の明確性を保つため、各分析対象に対して専用のレポートページを作成することを推奨します。レポートビューの下部にあるページタブの右側のプラスアイコンをクリックして、新しいページを追加します。ページ名を右クリックして「ページの名前変更」を選択し、わかりやすい名前を付けます。例えば、UF→RO分析_生産直後、UF→RO分析_使用直前、RO→RT分析_生産直後、RO→RT分析_使用直前といった命名が有効です。

各ページには、散布図ビジュアル、時間窓スライサー、集計可能ロット数カード、決定係数カードを配置します。これにより、ユーザーは時間窓を切り替えながら、相関関係の変化と集計対象ロット数の変動を同時に把握できます。

### RO→RT分析_生産直後ページの散布図作成

まず、RO→RT分析_生産直後ページを作成します。これは時間窓分析実装ガイドで詳述した主要な分析対象であり、他の分析対象の基本パターンとなります。

レポートキャンバスの右側にある視覚化ペインから散布図アイコンを選択します。散布図の枠がキャンバスに配置されるので、適切なサイズに調整します。推奨サイズは、キャンバスの中央部分を占める大きさ、例えば幅800ピクセル、高さ600ピクセル程度です。

散布図の設定は、フィールドペインとビジュアルフォーマットペインを使用して行います。まず、フィールドペインでCalc_RO保管統計_生産直後テーブルを展開し、平均温度列を散布図のX軸フィールドにドラッグします。次に、Cur_ロット系譜テーブルを展開し、RT性能F列をY軸フィールドにドラッグします。

詳細フィールドには、プロット点を個別に識別するための列を配置します。ここでは、ROロットとRTロットの組み合わせを使用します。Cur_ロット系譜テーブルからROロット列を詳細フィールドにドラッグし、続けてRTロット列も詳細フィールドにドラッグします。これにより、各ROロットとRTロットの組み合わせが個別のプロット点として表示されます。

凡例フィールドには、Dim_時間窓マスタテーブルの時間窓名列をドラッグします。ただし、生産直後の分析ページでは生産直後タイプの時間窓のみを表示したいため、ページレベルフィルタを設定する必要があります。フィルターペインでDim_時間窓マスタテーブルの時間窓タイプ列をページレベルフィルタにドラッグし、生産直後のみにチェックを入れます。これにより、凡例には生産直後0-6hr、生産直後0-12hr、生産直後0-24hr、生産直後0-48hrのみが表示されます。

### トレンドラインと決定係数の追加

散布図にトレンドラインを追加することで、データの傾向を視覚的に把握し、決定係数R²を表示できます。散布図を選択した状態で、ビジュアルフォーマットペインを開きます。分析セクションを展開し、トレンドラインのスイッチをオンにします。

トレンドラインの設定で、種類として線形を選択します。線の色は既定値のままでも構いませんが、視認性を高めるため、やや濃い色（例：ダークグレー）に変更することを推奨します。線の太さは2ピクセル程度が適切です。

トレンドラインの詳細設定を展開し、R²値を表示するオプションをオンにします。これにより、散布図上にR²値が数値として表示されます。表示位置は既定では右上となりますが、データの分布状況に応じて調整可能です。

複数の時間窓を同時に表示している場合、各時間窓に対してトレンドラインが個別に表示されます。これにより、時間窓ごとの相関強度の違いを視覚的に比較できます。仮説通りであれば、短い時間窓（6時間）のトレンドラインの傾きが急で、R²値が高く、長い時間窓（48時間）ではトレンドラインの傾きが緩やかでR²値が低くなることが観測されるはずです。

### 時間窓スライサーの配置

散布図の上部に時間窓スライサーを配置します。視覚化ペインからスライサーアイコンを選択し、キャンバスの上部に配置します。フィールドペインからDim_時間窓マスタの時間窓名列をスライサーの値フィールドにドラッグします。

スライサーのスタイルは、リストまたはドロップダウンが適切です。視覚化ペインのフォーマット設定で、スライサータイプとしてリストを選択し、複数選択を有効にします。これにより、ユーザーは複数の時間窓を同時に選択して比較できます。

スライサーにもページレベルフィルタの時間窓タイプが適用されるため、生産直後の4つの時間窓のみが選択肢として表示されます。初期状態では、すべての時間窓が選択された状態とすることで、散布図に4色のプロット点が表示されます。

### 他の分析対象の散布図作成

RO→RT分析_生産直後ページの散布図が完成したら、同様の手順で他の分析対象の散布図を作成します。主な違いは、参照するテーブルとフィールドの組み合わせです。

UF→RO分析_生産直後ページでは、X軸にCalc_UF保管統計_生産直後[平均温度]、Y軸にCur_ロット系譜[RO性能F]、詳細にCur_ロット系譜[UFロット]とCur_ロット系譜[ROロット]を使用します。

RT→製品分析_生産直後ページでは、X軸にCalc_RT保管統計_生産直後[平均温度]、Y軸にCur_ロット系譜[性能F]、詳細にCur_ロット系譜[RTロット]とCur_ロット系譜[製品ロット]を使用します。

RO→製品分析_生産直後（RTスキップ）ページでは、X軸にCalc_RO保管統計_生産直後[平均温度]、Y軸にCur_ロット系譜[性能F]、詳細にCur_ロット系譜[ROロット]とCur_ロット系譜[製品ロット]を使用します。さらに、RTスキップケースのみを分析対象とするため、ページレベルフィルタにCur_ロット系譜[RTロット]を追加し、空白を含むのチェックボックスのみを選択します。これにより、RTロットがNULLの製品のみが分析対象となります。

### 使用直前仮説の散布図作成

使用直前仮説を検証するためのページも同様に作成します。基本構造は生産直後と同じですが、参照する計算テーブルが異なります。例えば、RO→RT分析_使用直前ページでは、X軸にCalc_RO保管統計_使用直前[平均温度]を使用し、ページレベルフィルタでDim_時間窓マスタ[時間窓タイプ]を使用直前に設定します。

使用直前の時間窓は、使用直前6-0hr、使用直前12-0hr、使用直前24-0hr、使用直前48-0hrという表記となります。これは、保管終了時点から遡った時間範囲を示しています。仮説が正しければ、使用直前の短い時間窓ほど相関が強く、長い時間窓では相関が弱まることが観測されるはずです。

---

## 第6段階：相関分析メジャーと決定係数メジャーの作成

散布図のトレンドラインでR²値が表示されますが、より詳細な分析や条件付きフィルタリングを行うためには、DAXメジャーとして相関係数と決定係数を作成する必要があります。

### メジャーの配置場所

DAXメジャーは、専用の計算グループまたは関連するテーブルに配置します。Power BIでは、メジャーをどのテーブルに配置しても機能的には同じですが、管理性を考慮して、分析対象ごとにメジャーを整理することを推奨します。例えば、RO→RT分析に関連するメジャーはCalc_RO保管統計_生産直後テーブルに配置するといった方法です。

あるいは、すべての分析メジャーを一元管理するため、Measuresという名前の空のテーブルを作成することも一般的です。モデリングビューで新しいテーブルを選択し、DAX式として単純に Measures = ROW("Dummy", 1) と入力し、すぐにこのテーブルを非表示にします。このテーブルはデータを持たず、メジャーの入れ物としてのみ機能します。

### RO→RT分析_生産直後の相関係数メジャー

相関係数は、2つの変数間の線形関係の強さと方向を示す統計量です。値の範囲は-1から1までであり、1に近いほど正の強い相関、-1に近いほど負の強い相関、0に近いほど相関がないことを示します。

Power BIのホームタブまたはモデリングタブから新しいメジャーを選択し、以下のDAX式を入力します。メジャー名は、分析内容が明確にわかるように命名します。

```dax
相関係数_RO温度_RT性能F_生産直後 = 
VAR データテーブル = 
    FILTER(
        CROSSJOIN(
            Calc_RO保管統計_生産直後,
            Cur_ロット系譜
        ),
        Calc_RO保管統計_生産直後[ROロット] = Cur_ロット系譜[ROロット]
            && NOT(ISBLANK(Calc_RO保管統計_生産直後[平均温度]))
            && NOT(ISBLANK(Cur_ロット系譜[RT性能F]))
            && NOT(ISBLANK(Cur_ロット系譜[RTロット]))
    )
VAR N = COUNTROWS(データテーブル)
VAR SumX = SUMX(データテーブル, Calc_RO保管統計_生産直後[平均温度])
VAR SumY = SUMX(データテーブル, Cur_ロット系譜[RT性能F])
VAR SumXY = SUMX(データテーブル, Calc_RO保管統計_生産直後[平均温度] * Cur_ロット系譜[RT性能F])
VAR SumX2 = SUMX(データテーブル, POWER(Calc_RO保管統計_生産直後[平均温度], 2))
VAR SumY2 = SUMX(データテーブル, POWER(Cur_ロット系譜[RT性能F], 2))
VAR 分子 = N * SumXY - SumX * SumY
VAR 分母 = SQRT((N * SumX2 - POWER(SumX, 2)) * (N * SumY2 - POWER(SumY, 2)))
RETURN
    DIVIDE(分子, 分母, BLANK())
```

このメジャーの構造を詳しく説明します。最初の変数データテーブルでは、CROSSJOINによってCalc_RO保管統計_生産直後とCur_ロット系譜のすべての組み合わせを生成し、FILTERによって実際に関連があるROロットのペアのみを抽出します。さらに、平均温度またはRT性能Fが空白のレコードを除外し、RTロットが空白でないレコード（RTスキップケースでない）のみを対象とします。

変数Nはサンプル数を表し、SumX、SumY、SumXY、SumX2、SumY2は相関係数の計算に必要な統計量です。分子と分母を計算し、最終的にDIVIDE関数で除算することで相関係数を算出します。DIVIDE関数の第3引数としてBLANK()を指定することで、分母がゼロの場合に空白を返します。

### 決定係数メジャー

決定係数R²は、相関係数の2乗として定義されます。これは、一方の変数が他方の変数の変動のうち何パーセントを説明できるかを示す指標です。

```dax
決定係数R2_RO温度_RT性能F_生産直後 = 
POWER([相関係数_RO温度_RT性能F_生産直後], 2)
```

このメジャーは、既に作成した相関係数メジャーを参照し、その2乗を計算するだけのシンプルな定義です。メジャーが他のメジャーを参照することで、コードの重複を避け、保守性を高めることができます。

### 他の分析対象のメジャー作成

同様の構造で、他の分析対象と仮説タイプの組み合わせに対してもメジャーを作成します。テーブル名とフィールド名を適切に変更することで、同じロジックを適用できます。

UF→RO分析_生産直後のメジャーでは、Calc_UF保管統計_生産直後とCur_ロット系譜をCROSSJOINし、UFロットで結合し、RO性能Fとの相関を計算します。RT→製品分析_生産直後のメジャーでは、Calc_RT保管統計_生産直後とCur_ロット系譜をCROSSJOINし、RTロットで結合し、製品性能Fとの相関を計算します。

使用直前仮説のメジャーは、参照する計算テーブルを使用直前版に変更するだけで、計算ロジックは同一です。例えば、相関係数_RO温度_RT性能F_使用直前メジャーでは、Calc_RO保管統計_使用直前を使用します。

### RTスキップケースの特別処理

RO→製品分析（RTスキップ）のメジャーでは、RTロットがNULLである製品のみを対象とするため、フィルタ条件を追加します。

```dax
相関係数_RO温度_製品性能F_生産直後_RTスキップ = 
VAR データテーブル = 
    FILTER(
        CROSSJOIN(
            Calc_RO保管統計_生産直後,
            Cur_ロット系譜
        ),
        Calc_RO保管統計_生産直後[ROロット] = Cur_ロット系譜[ROロット]
            && ISBLANK(Cur_ロット系譜[RTロット])
            && NOT(ISBLANK(Calc_RO保管統計_生産直後[平均温度]))
            && NOT(ISBLANK(Cur_ロット系譜[性能F]))
    )
VAR N = COUNTROWS(データテーブル)
VAR SumX = SUMX(データテーブル, Calc_RO保管統計_生産直後[平均温度])
VAR SumY = SUMX(データテーブル, Cur_ロット系譜[性能F])
VAR SumXY = SUMX(データテーブル, Calc_RO保管統計_生産直後[平均温度] * Cur_ロット系譜[性能F])
VAR SumX2 = SUMX(データテーブル, POWER(Calc_RO保管統計_生産直後[平均温度], 2))
VAR SumY2 = SUMX(データテーブル, POWER(Cur_ロット系譜[性能F], 2))
VAR 分子 = N * SumXY - SumX * SumY
VAR 分母 = SQRT((N * SumX2 - POWER(SumX, 2)) * (N * SumY2 - POWER(SumY, 2)))
RETURN
    DIVIDE(分子, 分母, BLANK())
```

ISBLANK(Cur_ロット系譜[RTロット])という条件により、RTロットが空白の行のみが分析対象となります。

### メジャーの検証

作成したメジャーが正しく機能しているかを確認するため、カードビジュアルを使用します。レポートページにカードビジュアルを追加し、フィールドとして作成した決定係数メジャーを配置します。時間窓スライサーで特定の時間窓を選択した際に、カードの値が変化することを確認します。

また、複数の時間窓を選択した状態では、メジャーがすべての選択された時間窓のデータを統合して計算することに注意が必要です。時間窓ごとの個別のR²値を比較したい場合は、次の第7段階で作成する縦棒グラフを使用します。

---

## 第7段階：時間窓別R²比較の縦棒グラフ作成

時間窓の長さが相関強度に与える影響を視覚的に比較するため、横軸に時間窓、縦軸に決定係数R²を取った縦棒グラフを作成します。この比較により、仮説の核心部分である「短い時間窓ほど強い相関が観測される」ことを検証できます。

### 基本的な縦棒グラフの構成

RO→RT分析_生産直後ページに戻り、散布図の下部に縦棒グラフを配置するスペースを確保します。視覚化ペインから集合縦棒グラフアイコンを選択し、キャンバスの下部に配置します。

X軸フィールドには、Dim_時間窓マスタの時間窓名列をドラッグします。Y軸フィールドには、第6段階で作成した決定係数R2_RO温度_RT性能F_生産直後メジャーをドラッグします。これにより、各時間窓のR²値が棒グラフとして表示されます。

縦棒グラフのフォーマット設定で、X軸の並び順を制御します。ビジュアルフォーマットペインのX軸セクションを展開し、並び替えオプションを選択します。Dim_時間窓マスタの表示順序列で昇順に並び替えることで、生産直後0-6hr、0-12hr、0-24hr、0-48hrの順に左から右へ表示されます。

Y軸の範囲は、決定係数の性質上、0から1の範囲に収まります。Y軸の最小値を0、最大値を1に固定することで、異なる分析対象間での比較が容易になります。ただし、実際のR²値が非常に低い場合（例：すべて0.1以下）、固定範囲では差異が見えにくくなるため、自動範囲との切り替えができるようにしておくことも有効です。

### 目標線の追加

縦棒グラフに目標線を追加することで、統計的に意味のある相関の閾値を視覚化できます。一般的に、R²が0.5以上であれば中程度以上の相関、0.7以上であれば強い相関とされます。

ビジュアルフォーマットペインの分析セクションを展開し、定数線を追加します。Y軸の値として0.5を入力し、線の色を赤色またはオレンジ色に設定します。データラベルとして「中程度の相関（R²=0.5）」といったテキストを表示することで、ユーザーが基準を理解しやすくなります。

同様に、R²=0.7の位置にも別の定数線を追加し、色を緑色に設定します。これにより、各時間窓のR²値が統計的にどの程度意味があるかを即座に判断できます。

### データラベルの表示

各棒グラフの上部に具体的なR²値を表示することで、数値の正確な把握が可能となります。ビジュアルフォーマットペインのデータラベルセクションを展開し、表示をオンにします。小数点以下の桁数は3桁程度が適切です。例えば、0.645といった表示となります。

データラベルの位置は、棒の内側上部または棒の外側上部のいずれかを選択できます。R²値が小さい場合は外側上部、大きい場合は内側上部が視認性が良好です。

### 生産直後と使用直前の比較グラフ

さらに高度な分析として、同一のグラフ上に生産直後と使用直前の両方のR²値を並べて表示する比較グラフを作成できます。これには、集合縦棒グラフではなく、集合縦棒グラフを使用します。

新しいレポートページを作成し、RO→RT比較分析と命名します。集合縦棒グラフを配置し、X軸に時間窓の長さ（6、12、24、48）を表す列を使用します。ただし、Dim_時間窓マスタには生産直後と使用直前で異なる時間窓名が定義されているため、時間窓の長さのみを抽出する計算列またはメジャーを作成する必要があります。

Dim_時間窓マスタに新しい計算列を追加します。

```dax
時間窓長さ = 
ABS(Dim_時間窓マスタ[終了時間_相対] - Dim_時間窓マスタ[開始時間_相対])
```

この計算列により、すべての時間窓について6、12、24、48という統一された値が得られます。

比較グラフのX軸には時間窓長さ列を、凡例には時間窓タイプ列を、Y軸には決定係数メジャーを配置します。これにより、各時間窓長さに対して、生産直後と使用直前の2つの棒グラフが並んで表示されます。

この比較により、生産直後の熱履歴と使用直前の熱履歴のどちらがより強く性能に影響するかを一目で把握できます。仮説通りであれば、両方のタイプで時間窓が長くなるほどR²値が減少する傾向が観測されますが、どちらのタイプがより強い影響を持つかは、製造プロセスの特性によって異なる可能性があります。

### 他の分析対象の縦棒グラフ作成

同様の手順で、UF→RO分析、RT→製品分析、RO→製品分析（RTスキップ）の各ページにも時間窓別R²比較グラフを作成します。参照するメジャーを対応する決定係数メジャーに変更するだけで、グラフの構造は同一です。

すべての分析対象のグラフを作成したら、統合ビューページを作成し、すべての分析対象のR²値を一つのマトリックスまたは複数のグラフで比較表示することも有効です。これにより、どの工程間関係で最も強い熱履歴の影響が観測されるかを総合的に評価できます。

---

## 補足：集計可能ロット数の可視化

時間窓が長くなるほど、保管期間の短いロットは集計対象から外れ、集計可能なロット数が減少します。この情報をレポートに明示することで、分析結果の信頼性と統計的妥当性を評価できます。

### 集計可能ロット数メジャーの作成

各計算テーブルには計測回数列が含まれています。計測回数が1以上のロットのみが、その時間窓で平均温度を算出できたロットとなります。集計可能ロット数をカウントするメジャーを作成します。

```dax
集計可能ROロット数_生産直後 = 
CALCULATE(
    DISTINCTCOUNT(Calc_RO保管統計_生産直後[ROロット]),
    Calc_RO保管統計_生産直後[計測回数] >= 1
)
```

このメジャーは、計測回数が1以上の行のみを対象として、ROロットの重複を除いた数をカウントします。時間窓スライサーと連動するため、選択された時間窓に応じて値が変化します。

同様に、全体のROロット数をカウントするメジャーも作成します。

```dax
全ROロット数 = 
DISTINCTCOUNT(Cur_ロット系譜[ROロット])
```

これにより、集計率を計算するメジャーを作成できます。

```dax
集計率_生産直後 = 
DIVIDE([集計可能ROロット数_生産直後], [全ROロット数], 0)
```

### カードビジュアルでの表示

各分析ページの上部または側部に、集計可能ロット数と集計率を表示するカードビジュアルを配置します。視覚化ペインからカードアイコンを選択し、フィールドとして集計可能ROロット数_生産直後メジャーを配置します。

カードのフォーマット設定で、カテゴリラベルを表示し、「集計可能ROロット数」といったテキストを設定します。データラベルのフォントサイズを大きく（例：36ポイント）し、視認性を高めます。

隣接して、集計率を表示する別のカードビジュアルを配置します。集計率はパーセンテージ形式で表示するため、メジャーの書式設定でパーセンテージを選択し、小数点以下1桁程度とします。

### マトリックスビジュアルでの詳細表示

より詳細な情報を提供するため、時間窓別の集計可能ロット数と集計率を一覧表示するマトリックスビジュアルを作成することも有効です。視覚化ペインからマトリックスアイコンを選択し、行にDim_時間窓マスタの時間窓名列を、値に集計可能ROロット数_生産直後メジャーと集計率_生産直後メジャーを配置します。

マトリックスのフォーマット設定で、条件付き書式を適用できます。集計率列に対して、値が低い場合（例：50パーセント未満）に赤色の背景、高い場合（例：80パーセント以上）に緑色の背景を設定することで、どの時間窓で十分なサンプル数が確保されているかを視覚的に把握できます。

このマトリックスにより、ユーザーは時間窓48時間では集計可能ロット数が6時間の半分程度に減少していることなどを具体的に確認でき、R²値の解釈に役立てることができます。

---

## 検証手順

すべてのビジュアルとメジャーの作成が完了したら、以下の検証手順を実施し、実装が正しく機能していることを確認します。

### 検証1：時間窓スライサーの動作確認

RO→RT分析_生産直後ページを開き、時間窓スライサーですべての選択を解除した後、生産直後0-6hrのみを選択します。散布図のプロット点が単一の色のみで表示され、凡例にも0-6hrのみが表示されることを確認します。決定係数カードの値と、散布図のトレンドラインに表示されるR²値が一致することを確認します。

次に、生産直後0-48hrを追加選択します。散布図に2色のプロット点が表示され、それぞれにトレンドラインが表示されることを確認します。決定係数カードの値が変化することを確認します。ただし、この場合のカード値は、両方の時間窓を統合したR²値となるため、個別の時間窓のR²値とは異なる点に注意します。

### 検証2：仮説の定性的検証

仮説では、短い時間窓ほど強い相関が観測されると予測しています。時間窓別R²比較グラフで、横軸の左側（6時間、12時間）の棒グラフが右側（24時間、48時間）より高い傾向があるかを確認します。

すべての時間窓で相関が観測されない場合、仮説が棄却される可能性があります。逆に、すべての時間窓で同程度の高いR²値が観測される場合、熱履歴の影響は時間窓の長さに依存しないことを示唆します。仮説通りの傾向が観測された場合、初期条件依存性の存在が支持されます。

### 検証3：集計可能ロット数の妥当性確認

時間窓スライサーで生産直後0-6hrを選択した状態で、集計可能ROロット数カードの値を記録します。次に、生産直後0-48hrに切り替え、カードの値が減少することを確認します。保管期間が短いロットは48時間の時間窓では集計できないため、ロット数が減少するはずです。

減少率が妥当かを判断するため、元データの保管期間分布を確認します。例えば、ROロット全体の30パーセントが保管期間24時間未満である場合、48時間の時間窓では約30パーセントのロットが集計不可能となるはずです。

### 検証4：複数分析対象間の比較

UF→RO分析、RO→RT分析、RT→製品分析の各ページで、同じ時間窓（例：生産直後0-12hr）におけるR²値を比較します。どの工程間関係で最も強い相関が観測されるかを確認します。製造プロセスの特性により、特定の工程で熱履歴の影響が顕著である可能性があります。

### 検証5：生産直後と使用直前の比較

同一の工程間関係について、生産直後仮説と使用直前仮説のR²値を比較します。比較分析ページの集合縦棒グラフで、どちらのタイプが全体的に高いR²値を示すかを確認します。

両方のタイプで同程度のR²値が観測される場合、原料の熱履歴は生産直後と使用直前の両方で重要であることを示唆します。一方のタイプのみで強い相関が観測される場合、そのタイプの熱履歴管理に特に注力すべきことを示唆します。

### 検証6：RTスキップケースの特性

RO→製品分析（RTスキップ）ページで観測されるR²値と、通常のRO→RT→製品の経路でのR²値を比較します。RTスキップケースでは、RO品が直接製品に使用されるため、RO品の熱履歴の影響がより直接的に観測される可能性があります。

RTスキップケースのサンプル数が少ない場合、R²値の信頼性が低下する点に注意します。集計可能ロット数カードで、十分なサンプル数が確保されているかを確認します。

### 検証完了の確認

すべての検証項目で期待される動作が確認されたら、実装は完了です。レポートをエクスポートまたは公開し、関係者と共有して、仮説の検証結果を議論します。

データの更新時には、新しいロットや計測データが追加されることで、R²値が変化する可能性があります。定期的にレポートを確認し、時間窓と相関強度の関係が一貫しているかをモニタリングすることが重要です。

---

## まとめ

本ガイドでは、第4段階のリレーションシップ構築から第7段階の時間窓別R²比較グラフ作成までの詳細な実装手順を説明しました。これらの段階を通じて、原料の生産直後および使用直前の熱履歴が製品性能に与える影響を定量的に検証するための分析環境が完成します。

リレーションシップの正しい構築により、時間窓スライサーでの選択がすべての関連ビジュアルに適切に反映されます。散布図とトレンドラインにより、保管温度と性能の相関関係を視覚的に把握できます。DAXメジャーによる相関係数と決定係数の計算により、統計的な相関強度を定量化できます。時間窓別R²比較グラフにより、時間窓の長さが相関強度に与える影響を明確に評価できます。

集計可能ロット数の可視化により、各時間窓における分析の信頼性を評価できます。これらのビジュアルとメジャーを組み合わせることで、初期条件依存性という仮説を多角的に検証し、製造工程における熱履歴管理の最適化に向けた意思決定を支援します。

実装後は、実際のデータを用いた検証を通じて、仮説が支持されるか棄却されるかを科学的に評価し、その結果を製造プロセスの改善に活用することが期待されます。
