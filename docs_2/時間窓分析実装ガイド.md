# 時間窓分析実装ガイド：RO品初期温度とRT性能の相関検証

## 目次

1. [概要](#概要)
2. [テーブル構造の詳細](#テーブル構造の詳細)
3. [第1段階：計測ログテーブルへの列追加](#第1段階計測ログテーブルへの列追加)
4. [第2段階：Dim_時間窓マスタの作成](#第2段階dim_時間窓マスタの作成)
5. [第3段階：Calc_RO保管統計の作成](#第3段階calc_ro保管統計の作成)
6. [第4段階：リレーションシップの構築](#第4段階リレーションシップの構築)
7. [データフロー全体図](#データフロー全体図)

---

## 概要

本ドキュメントは、RO品の生産直後（保管開始直後）の温度がRT製品の性能に与える影響を分析するためのデータモデル拡張手順を説明します。この分析では、保管開始から6時間、12時間、24時間、48時間といった異なる時間窓での平均温度を算出し、それぞれの時間窓における温度とRT性能Fの相関関係を検証します。

分析の核心は、短い時間窓ほど初期温度の影響が直接的に観測され、長い時間窓では外乱要因により相関が希釈されるという仮説の検証にあります。このため、時間窓を柔軟に切り替えて分析できるデータモデルの構築が必要となります。

---

## テーブル構造の詳細

実装後の各テーブルの構造を以下に示します。

### テーブル1：Cur_計測ログ_RO（拡張後）

既存のCur_計測ログ_ROテーブルに2つの列を追加します。

| 列名 | データ型 | 説明 | 追加/既存 |
|------|---------|------|----------|
| created_at | DateTime | 計測日時 | 既存 |
| センサナンバー | Integer | センサー番号 | 既存 |
| LOT | Text | ROロット番号 | 既存 |
| 保管場所 | Text | 保管エリア | 既存 |
| Temperature | Number | 温度（℃） | 既存 |
| Humidity | Number | 相対湿度（％） | 既存 |
| 絶対湿度 | Number | 絶対湿度（g/m³） | 既存 |
| **保管開始時刻** | **DateTime** | **このROロットの保管開始時刻（ステータス0の日時）** | **追加** |
| **経過時間_時間** | **Number** | **保管開始からの経過時間（時間単位）** | **追加** |

**データ例：**

| created_at | センサナンバー | LOT | 保管場所 | Temperature | Humidity | 絶対湿度 | 保管開始時刻 | 経過時間_時間 |
|-----------|--------------|-----|---------|-------------|----------|---------|-------------|--------------|
| 2025-10-24 09:40 | 42 | K25X240200 | エリアA | 24.5 | 45.2 | 10.2 | 2025-10-24 09:40 | 0.0 |
| 2025-10-24 10:40 | 42 | K25X240200 | エリアA | 25.1 | 44.8 | 10.5 | 2025-10-24 09:40 | 1.0 |
| 2025-10-24 15:40 | 42 | K25X240200 | エリアC | 24.8 | 45.0 | 10.3 | 2025-10-24 09:40 | 6.0 |
| 2025-10-25 03:40 | 42 | K25X240200 | エリアB | 24.2 | 45.5 | 10.1 | 2025-10-24 09:40 | 18.0 |

同様の列をCur_計測ログ_RTとCur_計測ログ_UFにも追加します。

---

### テーブル2：Dim_時間窓マスタ（新規作成）

時間窓の定義を格納するディメンションテーブルです。このテーブルは手動で作成するか、Power Queryで生成します。

| 列名 | データ型 | 説明 |
|------|---------|------|
| 時間窓ID | Integer | 時間窓の識別子（主キー） |
| 時間窓名 | Text | 時間窓の表示名 |
| 開始時間_相対 | Number | 保管開始からの開始時間（時間単位） |
| 終了時間_相対 | Number | 保管開始からの終了時間（時間単位） |
| 表示順序 | Integer | ビジュアルでの並び順 |

**データ例：**

| 時間窓ID | 時間窓名 | 開始時間_相対 | 終了時間_相対 | 表示順序 |
|---------|---------|--------------|-------------|---------|
| 1 | 0-6hr | 0 | 6 | 1 |
| 2 | 0-12hr | 0 | 12 | 2 |
| 3 | 0-24hr | 0 | 24 | 3 |
| 4 | 0-48hr | 0 | 48 | 4 |

このテーブルは4行固定ですが、必要に応じて他の時間窓（例：0-3hr、0-72hrなど）を追加できます。

---

### テーブル3：Calc_RO保管統計（新規作成・計算テーブル）

各ROロットと各時間窓の組み合わせごとに、時間窓内の平均温度、平均湿度、平均絶対湿度を事前計算するテーブルです。このテーブルはDAXの計算テーブルとして作成されます。

| 列名 | データ型 | 説明 |
|------|---------|------|
| ROロット | Text | ROロット番号 |
| 時間窓ID | Integer | 時間窓の識別子 |
| 時間窓名 | Text | 時間窓の表示名 |
| 開始時間_相対 | Number | 保管開始からの開始時間（時間単位） |
| 終了時間_相対 | Number | 保管開始からの終了時間（時間単位） |
| 平均温度 | Number | 時間窓内の平均温度（℃） |
| 平均湿度 | Number | 時間窓内の平均相対湿度（％） |
| 平均絶対湿度 | Number | 時間窓内の平均絶対湿度（g/m³） |
| 計測回数 | Integer | 時間窓内の計測データ件数 |

**データ例：**

| ROロット | 時間窓ID | 時間窓名 | 開始時間_相対 | 終了時間_相対 | 平均温度 | 平均湿度 | 平均絶対湿度 | 計測回数 |
|---------|---------|---------|--------------|-------------|---------|---------|-------------|---------|
| K25X240200 | 1 | 0-6hr | 0 | 6 | 24.8 | 45.0 | 10.3 | 6 |
| K25X240200 | 2 | 0-12hr | 0 | 12 | 24.6 | 45.1 | 10.2 | 12 |
| K25X240200 | 3 | 0-24hr | 0 | 24 | 24.5 | 45.3 | 10.1 | 24 |
| K25X240200 | 4 | 0-48hr | 0 | 48 | 24.3 | 45.5 | 10.0 | 48 |
| G25X240300 | 1 | 0-6hr | 0 | 6 | 25.2 | 44.5 | 10.6 | 6 |
| G25X240300 | 2 | 0-12hr | 0 | 12 | 25.0 | 44.7 | 10.5 | 12 |

このテーブルの行数は、ROロットの数×時間窓の数となります。例えば、ROロットが50個、時間窓が4種類であれば、200行になります。

---

## 第1段階：計測ログテーブルへの列追加

### 実装の背景

現在の計測ログテーブルには、各計測時刻における温度データは記録されていますが、その計測がロットの保管開始から何時間経過した時点のものかという情報がありません。時間窓分析を行うためには、各計測データが「保管開始から0～6時間の範囲」「保管開始から0～12時間の範囲」といった区分のどこに属するかを判定する必要があります。

このため、各計測ログに対して保管開始時刻を付与し、そこからの経過時間を計算する列を追加します。

### 保管開始時刻の特定方法

履歴表のステータス列において、ステータス0は保管開始を示します。各センサナンバー×LOTの組み合わせに対して、ステータス0の行の日時が保管開始時刻となります。この情報を計測ログテーブルに付与するには、履歴表からステータス0の行を抽出し、センサナンバーとLOTをキーとして計測ログテーブルと結合します。

### Power Query実装コード（Cur_計測ログ_RO用）

既存のCur_計測ログ_ROクエリを以下のように修正します。この処理は、現在のCur_計測ログ_ROクエリの最後のステップの後に追加します。

```powerquery
let
    // 既存のCur_計測ログ_ROの処理結果を取得
    既存クエリ = Cur_計測ログ_RO,
    
    // 履歴表からステータス0（保管開始）の行を抽出
    履歴表全体 = Link_履歴表,
    保管開始のみ = Table.SelectRows(履歴表全体, each [ステータス] = 0),
    保管開始必要列 = Table.SelectColumns(保管開始のみ, {"センサナンバー", "LOT", "日時"}),
    保管開始リネーム = Table.RenameColumns(保管開始必要列, {{"日時", "保管開始時刻"}}),
    
    // 計測ログと保管開始時刻を結合
    結合 = Table.NestedJoin(
        既存クエリ,
        {"センサナンバー", "LOT"},
        保管開始リネーム,
        {"センサナンバー", "LOT"},
        "保管開始テーブル",
        JoinKind.LeftOuter
    ),
    
    // 結合したテーブルを展開
    展開 = Table.ExpandTableColumn(
        結合,
        "保管開始テーブル",
        {"保管開始時刻"},
        {"保管開始時刻"}
    ),
    
    // 経過時間を計算（時間単位）
    経過時間追加 = Table.AddColumn(
        展開,
        "経過時間_時間",
        each Duration.TotalHours([created_at] - [保管開始時刻]),
        type number
    )
in
    経過時間追加
```

### 実装のポイント

保管開始時刻の結合はLeftOuterJoinで行います。これは、万が一ステータス0が存在しないロットがあった場合でも計測ログ自体は残すためです（その場合、保管開始時刻と経過時間_時間はnullとなります）。

経過時間の計算にはDuration.TotalHours関数を使用します。これは、DateTimeの差分をDuration型として取得し、それを時間単位の数値に変換します。例えば、created_atが2025-10-24 15:40で保管開始時刻が2025-10-24 09:40の場合、経過時間_時間は6.0となります。

同様の処理をCur_計測ログ_RTとCur_計測ログ_UFにも適用します。コードは同一ですが、対象テーブル名を変更してください。

---

## 第2段階：Dim_時間窓マスタの作成

### 手動作成の方法

Power BIのモデリングビューで、新しいテーブルを作成します。リボンの「テーブルツール」から「新しいテーブル」を選択し、以下のDAX式を入力します。

```dax
Dim_時間窓マスタ = 
DATATABLE(
    "時間窓ID", INTEGER,
    "時間窓名", STRING,
    "開始時間_相対", INTEGER,
    "終了時間_相対", INTEGER,
    "表示順序", INTEGER,
    {
        {1, "0-6hr", 0, 6, 1},
        {2, "0-12hr", 0, 12, 2},
        {3, "0-24hr", 0, 24, 3},
        {4, "0-48hr", 0, 48, 4}
    }
)
```

このDAX式は、4行のデータを持つテーブルを直接定義します。DATATABLE関数は、列定義とデータを同時に指定できる便利な関数です。

### Power Queryでの作成方法（代替案）

Power Queryで作成する場合は、新しいブランククエリを作成し、以下のM言語コードを入力します。

```powerquery
let
    テーブル作成 = #table(
        {"時間窓ID", "時間窓名", "開始時間_相対", "終了時間_相対", "表示順序"},
        {
            {1, "0-6hr", 0, 6, 1},
            {2, "0-12hr", 0, 12, 2},
            {3, "0-24hr", 0, 24, 3},
            {4, "0-48hr", 0, 48, 4}
        }
    ),
    型変更 = Table.TransformColumnTypes(
        テーブル作成,
        {
            {"時間窓ID", Int64.Type},
            {"時間窓名", type text},
            {"開始時間_相対", Int64.Type},
            {"終了時間_相対", Int64.Type},
            {"表示順序", Int64.Type}
        }
    )
in
    型変更
```

どちらの方法でも同じテーブルが作成されます。DAX版の方がシンプルなため推奨します。

---

## 第3段階：Calc_RO保管統計の作成

### DAX実装の詳細解説

Calc_RO保管統計テーブルは、DAXの計算テーブルとして作成します。このテーブルの作成ロジックは以下の3つのステップから構成されます。

#### ステップ1：ROロット一覧の取得

まず、Cur_ロット系譜テーブルから重複を排除したROロット一覧を取得します。

```dax
VAR ROロット一覧 = 
    DISTINCT(SELECTCOLUMNS(
        Cur_ロット系譜,
        "ROロット", [ROロット]
    ))
```

この変数ROロット一覧には、すべてのユニークなROロット番号が格納されます。

#### ステップ2：ROロット×時間窓のクロス結合

次に、ROロット一覧とDim_時間窓マスタをクロス結合します。これにより、すべてのROロットとすべての時間窓の組み合わせが生成されます。

```dax
VAR 時間窓一覧 = 
    CROSSJOIN(
        ROロット一覧,
        Dim_時間窓マスタ
    )
```

この時点で、時間窓一覧テーブルには以下の列が含まれます。

- ROロット（ROロット一覧から）
- 時間窓ID（Dim_時間窓マスタから）
- 時間窓名（Dim_時間窓マスタから）
- 開始時間_相対（Dim_時間窓マスタから）
- 終了時間_相対（Dim_時間窓マスタから）
- 表示順序（Dim_時間窓マスタから）

**重要な補足：この段階で時間窓ID列が存在します。** これが質問への回答となります。CROSSJOINによってDim_時間窓マスタのすべての列が結果テーブルに含まれるため、時間窓ID列も自動的に存在することになります。

#### ステップ3：各組み合わせに対する統計値の計算

最後に、各ROロット×時間窓の組み合わせに対して、時間窓内の平均温度、平均湿度、平均絶対湿度、計測回数を計算します。

```dax
VAR 統計テーブル = 
    ADDCOLUMNS(
        時間窓一覧,
        "平均温度", 
            VAR CurrentRO = [ROロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_RO[Temperature]),
                Cur_計測ログ_RO[LOT] = CurrentRO,
                Cur_計測ログ_RO[経過時間_時間] >= 開始,
                Cur_計測ログ_RO[経過時間_時間] < 終了
            ),
        "平均湿度",
            VAR CurrentRO = [ROロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_RO[Humidity]),
                Cur_計測ログ_RO[LOT] = CurrentRO,
                Cur_計測ログ_RO[経過時間_時間] >= 開始,
                Cur_計測ログ_RO[経過時間_時間] < 終了
            ),
        "平均絶対湿度",
            VAR CurrentRO = [ROロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_RO[絶対湿度]),
                Cur_計測ログ_RO[LOT] = CurrentRO,
                Cur_計測ログ_RO[経過時間_時間] >= 開始,
                Cur_計測ログ_RO[経過時間_時間] < 終了
            ),
        "計測回数",
            VAR CurrentRO = [ROロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                COUNTROWS(Cur_計測ログ_RO),
                Cur_計測ログ_RO[LOT] = CurrentRO,
                Cur_計測ログ_RO[経過時間_時間] >= 開始,
                Cur_計測ログ_RO[経過時間_時間] < 終了
            )
    )
```

ADDCOLUMNSは、既存のテーブル（時間窓一覧）に新しい計算列を追加する関数です。各新規列の計算では、現在の行のROロットと時間窓の情報を変数に格納し、それを使ってCur_計測ログ_ROからデータをフィルタリングして集計します。

CALCULATE関数内のフィルタ条件は以下の3つです。

1. `Cur_計測ログ_RO[LOT] = CurrentRO`：現在処理中のROロットのデータのみを対象
2. `Cur_計測ログ_RO[経過時間_時間] >= 開始`：時間窓の開始時刻以降のデータ
3. `Cur_計測ログ_RO[経過時間_時間] < 終了`：時間窓の終了時刻未満のデータ（半開区間）

例えば、時間窓が0-6hrの場合、経過時間_時間が0以上6未満のデータのみが集計対象となります。

### 完全なDAX定義

上記の3ステップを統合した完全なDAX定義は以下の通りです。Power BIのモデリングビューで、「新しいテーブル」を選択し、以下のコードを入力します。

```dax
Calc_RO保管統計 = 
VAR ROロット一覧 = 
    DISTINCT(SELECTCOLUMNS(
        Cur_ロット系譜,
        "ROロット", [ROロット]
    ))
VAR 時間窓一覧 = 
    CROSSJOIN(
        ROロット一覧,
        Dim_時間窓マスタ
    )
VAR 統計テーブル = 
    ADDCOLUMNS(
        時間窓一覧,
        "平均温度", 
            VAR CurrentRO = [ROロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_RO[Temperature]),
                Cur_計測ログ_RO[LOT] = CurrentRO,
                Cur_計測ログ_RO[経過時間_時間] >= 開始,
                Cur_計測ログ_RO[経過時間_時間] < 終了
            ),
        "平均湿度",
            VAR CurrentRO = [ROロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_RO[Humidity]),
                Cur_計測ログ_RO[LOT] = CurrentRO,
                Cur_計測ログ_RO[経過時間_時間] >= 開始,
                Cur_計測ログ_RO[経過時間_時間] < 終了
            ),
        "平均絶対湿度",
            VAR CurrentRO = [ROロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_RO[絶対湿度]),
                Cur_計測ログ_RO[LOT] = CurrentRO,
                Cur_計測ログ_RO[経過時間_時間] >= 開始,
                Cur_計測ログ_RO[経過時間_時間] < 終了
            ),
        "計測回数",
            VAR CurrentRO = [ROロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                COUNTROWS(Cur_計測ログ_RO),
                Cur_計測ログ_RO[LOT] = CurrentRO,
                Cur_計測ログ_RO[経過時間_時間] >= 開始,
                Cur_計測ログ_RO[経過時間_時間] < 終了
            )
    )
RETURN
    統計テーブル
```

### GENERATE定義について（疑問点への回答）

ご質問にあった最初のGENERATE定義は、説明の途中で提示した簡易版でしたが、「しかし、実際には各ROロットの保管開始時刻を特定し、時間窓内の平均温度を計算する必要があるため、より複雑な構造が必要です」と記載した通り、この定義では不完全でした。

GENERATE版では、ROロット一覧と時間窓マスタをクロス結合することまでは実現できますが、各組み合わせに対する平均温度などの統計値を計算する部分が含まれていませんでした。そのため、最終的にはADDCOLUMNSを使った完全版の定義を使用します。

**結論：GENERATE版は使用せず、上記のADDCOLUMNS版の完全なDAX定義を使用してください。**

---

## 第4段階：リレーションシップの構築

### リレーションシップ1：Dim_時間窓マスタ → Calc_RO保管統計

Power BIのモデルビューで、以下のリレーションシップを作成します。

**接続元テーブル：** Dim_時間窓マスタ
**接続元列：** 時間窓ID
**接続先テーブル：** Calc_RO保管統計
**接続先列：** 時間窓ID
**カーディナリティ：** 一対多（1:*）
**クロスフィルタ方向：** 単一（Dim_時間窓マスタ → Calc_RO保管統計）

このリレーションシップにより、Dim_時間窓マスタで特定の時間窓（例：0-6hr）を選択すると、Calc_RO保管統計は該当する時間窓のデータのみにフィルタリングされます。

### リレーションシップ2：Calc_RO保管統計 → Cur_ロット系譜

**接続元テーブル：** Calc_RO保管統計
**接続元列：** ROロット
**接続先テーブル：** Cur_ロット系譜
**接続先列：** ROロット
**カーディナリティ：** 多対多（*:*）
**クロスフィルタ方向：** 双方向（Both）

カーディナリティが多対多となる理由は、先に説明した通り、以下の構造によるものです。

Calc_RO保管統計側では、同じROロットが時間窓の数だけ繰り返されます。例えば、ROロット「K25X240200」は、0-6hr、0-12hr、0-24hr、0-48hrの4行として存在します。そのため、ROロット列は非一意です。

Cur_ロット系譜側では、同じROロットが複数の製品ロットで使用されます。例えば、ROロット「K25X240200」が製品ロット「P001」「P002」「P003」で使用されている場合、3行として存在します。そのため、ROロット列は非一意です。

したがって、両側とも非一意であるため、多対多のリレーションシップとなります。

クロスフィルタ方向を双方向にする理由は、分析の柔軟性を確保するためです。例えば、特定の製品ロットを選択した際に、そのROロットの保管統計データにフィルタを適用したい場合や、逆に特定の時間窓と平均温度範囲でフィルタした際に、該当する製品を表示したい場合があります。

### リレーションシップ3：Cur_計測ログ_RO → Cur_ロット系譜（既存）

このリレーションシップは、パターンA設計時に既に構築されているはずですが、念のため確認します。

**接続元テーブル：** Cur_計測ログ_RO
**接続元列：** LOT
**接続先テーブル：** Cur_ロット系譜
**接続先列：** ROロット
**カーディナリティ：** 多対多（*:*）
**クロスフィルタ方向：** 双方向（Both）

### リレーションシップ構成図

最終的なリレーションシップ構成は以下の通りです。

```
Dim_時間窓マスタ[時間窓ID]
    ↓ (一対多、単一方向)
Calc_RO保管統計[時間窓ID, ROロット]
    ↓ (多対多、双方向)
Cur_ロット系譜[ROロット]
    ↓ (多対多、双方向)
Cur_計測ログ_RO[LOT]
```

この構成により、時間窓スライサーで選択した時間窓に応じて、Calc_RO保管統計がフィルタされ、さらにそのROロットに紐づく製品情報や詳細な計測ログにもアクセスできます。

---

## データフロー全体図

実装完了後のデータフロー全体を以下に示します。

```mermaid
flowchart TB
    subgraph 入力データ
        HIST[履歴表<br/>ステータス0,1,2]
        LOG[Cur_計測ログ_RO<br/>既存版]
    end
    
    subgraph 第1段階：列追加
        HIST -->|ステータス0抽出| START[保管開始時刻テーブル]
        LOG -->|結合| ENHANCED[Cur_計測ログ_RO<br/>拡張版<br/>+保管開始時刻<br/>+経過時間_時間]
        START -->|LEFT JOIN| ENHANCED
    end
    
    subgraph 第2段階：時間窓マスタ
        TW[Dim_時間窓マスタ<br/>時間窓ID: 1-4<br/>時間窓名: 0-6hr等]
    end
    
    subgraph 第3段階：保管統計計算
        GEN[ROロット一覧<br/>+<br/>時間窓マスタ]
        CROSS[CROSSJOIN<br/>ROロット×時間窓]
        CALC[ADDCOLUMNS<br/>平均温度等を計算]
        STAT[Calc_RO保管統計<br/>ROロット<br/>時間窓ID<br/>平均温度<br/>平均湿度<br/>平均絶対湿度<br/>計測回数]
        
        GEN --> CROSS --> CALC --> STAT
        ENHANCED -.計測データ参照.-> CALC
    end
    
    subgraph 第4段階：リレーションシップ
        SYS[Cur_ロット系譜<br/>製品ロット<br/>RTロット<br/>ROロット<br/>UFロット<br/>性能F, 性能R]
        
        TW -->|時間窓ID<br/>一対多| STAT
        STAT -->|ROロット<br/>多対多、双方向| SYS
        ENHANCED -->|LOT→ROロット<br/>多対多、双方向| SYS
    end
    
    subgraph 分析レイヤー
        SCATTER[散布図<br/>X軸: 平均温度<br/>Y軸: RT性能F<br/>凡例: 時間窓名]
        R2[決定係数R²<br/>時間窓別比較]
        
        STAT --> SCATTER
        SYS --> SCATTER
        TW --> SCATTER
        STAT --> R2
        SYS --> R2
    end
    
    style ENHANCED fill:#e1f5ff
    style TW fill:#ffe1f0
    style STAT fill:#f0ffe1
    style SYS fill:#fff4e1
    style SCATTER fill:#e1ffe1
```

このフローチャートは、履歴表と計測ログから始まり、第1段階で経過時間列を追加し、第2段階で時間窓マスタを作成し、第3段階でクロス結合と統計計算を行い、第4段階でリレーションシップを構築し、最終的に散布図と決定係数分析につながる全体の流れを示しています。

---

## 実装チェックリスト

実装完了を確認するため、以下のチェックリストを使用してください。

### 第1段階チェック項目

- [ ] Cur_計測ログ_ROに保管開始時刻列が追加されている
- [ ] Cur_計測ログ_ROに経過時間_時間列が追加されている
- [ ] 保管開始時刻の値が履歴表のステータス0の日時と一致している
- [ ] 経過時間_時間が正しく計算されている（created_atが保管開始時刻より後の場合、正の値になる）
- [ ] Cur_計測ログ_RTとCur_計測ログ_UFにも同様の列が追加されている

### 第2段階チェック項目

- [ ] Dim_時間窓マスタテーブルが作成されている
- [ ] 4行のデータが正しく入力されている（0-6hr、0-12hr、0-24hr、0-48hr）
- [ ] 各列のデータ型が正しい（時間窓IDと表示順序はInteger、他はTextまたはNumber）

### 第3段階チェック項目

- [ ] Calc_RO保管統計テーブルが作成されている
- [ ] 行数がROロット数×4（時間窓数）になっている
- [ ] 時間窓ID列が存在し、1から4の値が格納されている
- [ ] ROロット列が存在し、すべてのROロットが含まれている
- [ ] 平均温度、平均湿度、平均絶対湿度、計測回数の列が存在する
- [ ] 各統計値が妥当な範囲の数値になっている（例：温度が-50℃～100℃の範囲など）

### 第4段階チェック項目

- [ ] Dim_時間窓マスタとCalc_RO保管統計の間にリレーションシップが構築されている
- [ ] リレーションシップのカーディナリティが一対多（1:*）になっている
- [ ] Calc_RO保管統計とCur_ロット系譜の間にリレーションシップが構築されている
- [ ] リレーションシップのカーディナリティが多対多（*:*）になっている
- [ ] クロスフィルタ方向が双方向（Both）になっている

---

## トラブルシューティング

### 問題1：経過時間_時間がすべてnullになる

**原因：** 履歴表にステータス0の行が存在しないか、センサナンバーまたはLOTの値が計測ログと一致していない可能性があります。

**解決策：** 履歴表でステータス0の行を確認し、センサナンバーとLOTの値が計測ログと完全に一致しているか検証してください。大文字小文字の違いや前後の空白にも注意してください。

### 問題2：Calc_RO保管統計の平均温度がすべてblankになる

**原因：** 経過時間_時間列が正しく計算されていないか、時間窓の範囲内に計測データが存在しない可能性があります。

**解決策：** Cur_計測ログ_ROの経過時間_時間列を確認し、0から48の範囲の値が存在するか確認してください。また、特定のROロットについて、計測データが十分に存在するか（最低でも6時間以上）確認してください。

### 問題3：散布図にデータが表示されない

**原因：** リレーションシップが正しく構築されていないか、フィルタによってデータが除外されている可能性があります。

**解決策：** モデルビューでリレーションシップを確認し、カーディナリティとクロスフィルタ方向が正しいか検証してください。また、ページレベルフィルタやビジュアルレベルフィルタで意図しないフィルタリングが行われていないか確認してください。

---

## まとめ

本ドキュメントでは、RO品の初期温度がRT製品の性能に与える影響を分析するためのデータモデル拡張手順を詳細に解説しました。特に重要なポイントは以下の通りです。

第一に、時間窓という概念をディメンションテーブル化することで、柔軟な時間範囲での集計が可能になります。第二に、Calc_RO保管統計テーブルは、ROロットと時間窓のすべての組み合わせに対して統計値を事前計算するテーブルであり、CROSSJOIN後にADDCOLUMNSで統計列を追加します。第三に、このテーブルには時間窓ID列が存在し、これによってDim_時間窓マスタとのリレーションシップが構築されます。第四に、多対多リレーションシップと双方向フィルタリングを適切に活用することで、柔軟な分析が実現します。

これらの実装により、短時間窓と長時間窓での相関の違いを定量的に比較し、初期条件依存性の仮説を検証できます。
