# 計測ログ保管場所割当処理 完全作業手順書

## 目次

1. [ドキュメント概要](#ドキュメント概要)
2. [前提条件](#前提条件)
3. [第1段階：有効期間テーブルの作成](#第1段階有効期間テーブルの作成)
4. [第2段階：有効期間フィルタの適用](#第2段階有効期間フィルタの適用)
5. [第3段階：FillDown処理による保管場所割当](#第3段階filldown処理による保管場所割当)
6. [第4段階：計算列の追加](#第4段階計算列の追加)
7. [第5段階：工程別テーブルへの分割](#第5段階工程別テーブルへの分割)
8. [トラブルシューティング](#トラブルシューティング)
9. [まとめ](#まとめ)

---

## ドキュメント概要

本ドキュメントは、製造業における保管環境分析のためのPower Queryデータフロー実装手順を記載した作業手順書である。計測ログデータに保管場所情報を付与し、工程別に分割されたテーブルを作成するまでの全工程を網羅している。

本作業手順書は、Power Queryの基本的な操作知識を持つ担当者が、本ドキュメントのみで作業を完遂できることを目的として作成されている。各段階の処理内容、GUI操作手順、完了後の確認方法を詳細に記載しており、別担当者への引き継ぎ資料としても使用可能である。

### 処理の全体像

本作業は5つの段階で構成されている。第1段階では履歴表からステータス0（保管開始）と2（保管終了）の行を抽出し、センサナンバーとロット番号の組み合わせごとに有効期間を作成する。第2段階では計測ログと有効期間テーブルをセンサナンバーで結合し、範囲フィルタを適用することで有効期間内の計測ログのみを抽出し、各計測ログに正しいロット番号を割り当てる。第3段階ではFillDown処理により計測ログと履歴表を時系列で統合し、各計測時刻における保管場所を特定する。第4段階ではロット番号から工程区分を判定する列と、温湿度から絶対湿度を計算する列を追加する。第5段階では工程区分に基づいてデータを3つのテーブルに分割し、各工程専用のテーブルを作成する。

これらの処理により、計測ログデータに保管場所情報が付与され、RT工程、RO工程、UF工程の3つの最終テーブルが作成される。

---

## 前提条件

本作業を開始する前に、以下の前提条件を満たしていることを確認する必要がある。

Power BI Desktop または Power Platform Dataflows の環境が利用可能であり、Power Query エディターにアクセスできることが必要である。SharePointフォルダまたは他のデータソースから、センサーマスタ、履歴表、計測ログの各CSVファイルが読み込み可能な状態であることを確認する。

データソースには以下の3つのテーブルが含まれている必要がある。センサーマスタテーブルには、センサーシリアル列とセンサナンバー列が含まれている。履歴表テーブルには、センサナンバー列、ロット番号列、保管場所列、日時列、ステータス列が含まれており、ステータス列には0（保管開始）、1（移動）、2（保管終了）のいずれかの値が設定されている。計測ログテーブルには、created_at列、serial列、field1（Temperature ºC）列、field2（Humidity）列が含まれている。

作業担当者は、Power Queryの基本操作（クエリの作成、列の選択、フィルタ、詳細エディターの使用）について理解していることが望ましい。

---

## 第1段階：有効期間テーブルの作成

### 処理概要

第1段階では、履歴表からステータス0（保管開始）とステータス2（保管終了）の行を抽出し、センサナンバーとロット番号の組み合わせごとに有効期間を作成する。この有効期間テーブルは、後続の第2段階で計測ログをフィルタする際の基準として使用される。

処理の流れは以下のとおりである。履歴表からステータス0の行を抽出し、センサナンバー、ロット番号、日時の3列を選択して日時列を「有効開始」にリネームする。同様に、履歴表からステータス2の行を抽出し、同じ3列を選択して日時列を「有効終了」にリネームする。これら2つのテーブルをセンサナンバーとロット番号の組み合わせで内部結合し、有効終了列を展開することで、各センサナンバーとロット番号の組み合わせに対して有効開始日時と有効終了日時が1行にまとめられたテーブルが作成される。

### GUI操作手順

#### ステップ1-1：開始行クエリの作成

Power Query エディターを開き、クエリペインでStg_履歴表クエリを右クリックして「参照」を選択する。新しいクエリが作成されるため、クエリ名を「開始行」に変更する。

プレビュー画面で「ステータス」列のヘッダー右側にある下向き矢印（フィルタボタン）をクリックし、フィルタメニューが表示されたら「すべて選択」のチェックを外し、「0」のみにチェックを入れてOKをクリックする。これにより、保管開始行のみが表示される。

ホームタブのリボンから「列の選択」をクリックし、ダイアログが表示されたら「センサナンバー」「LOT」「日時」の3列のみにチェックを入れ、その他の列のチェックを外してOKをクリックする。

「日時」列のヘッダーをダブルクリックし、列名を「有効開始」に変更してEnterキーを押す。

#### ステップ1-2：終了行クエリの作成

クエリペインでStg_履歴表クエリを右クリックして「参照」を選択し、新しいクエリを作成する。クエリ名を「終了行」に変更する。

「ステータス」列のフィルタで「2」のみにチェックを入れてOKをクリックする。これにより、保管終了行のみが表示される。

ホームタブのリボンから「列の選択」をクリックし、「センサナンバー」「LOT」「日時」の3列のみを選択する。

「日時」列のヘッダーをダブルクリックし、列名を「有効終了」に変更する。

#### ステップ1-3：開始行と終了行の結合

クエリペインで「開始行」クエリを選択した状態で、ホームタブのリボンから「クエリのマージ」をクリックする。

マージダイアログの上部テーブルで、Ctrlキーを押しながら「センサナンバー」列と「LOT」列の両方をクリックして選択する。列が選択されると、列ヘッダーに「1」「2」という番号が表示される。

下部のドロップダウンから「終了行」クエリを選択し、同様にCtrlキーを押しながら「センサナンバー」列と「LOT」列の両方をクリックして選択する。

「結合の種類」ドロップダウンから「内部（両方のテーブルから一致する行のみ）」を選択し、OKをクリックする。

新しく追加された「終了行」列のヘッダー右側にある展開ボタン（テーブルアイコンに二重矢印）をクリックする。展開ダイアログが表示されたら、「有効終了」列のみにチェックを入れ、「元の列名をプレフィックスとして使用します」のチェックを外してOKをクリックする。

クエリペインで「開始行」クエリを右クリックし、「名前の変更」を選択してクエリ名を「Stg_有効期間」に変更する。

### 完了後の確認

Stg_有効期間クエリのプレビューを確認する。以下の4列が表示されていることを確認する必要がある。

センサナンバー列はテキスト型で、センサーの識別番号が格納されている。LOT列はテキスト型で、ロット番号が格納されている。有効開始列はDateTime型で、保管開始日時が格納されている。有効終了列はDateTime型で、保管終了日時が格納されている。

各センサナンバーとロット番号の組み合わせごとに1行のデータが存在することを確認する。有効開始日時が有効終了日時よりも前の日時であることを確認する。データのサンプル例として、センサナンバー40、ロット番号Q25X231100、有効開始2025-10-23 18:10、有効終了2025-10-24 08:30のような行が含まれているはずである。

テーブルの行数が履歴表のステータス0の行数と一致していることを確認する。もし行数が少ない場合、ステータス2の行が不足しているセンサナンバーとロット番号の組み合わせが存在する可能性がある。

---

## 第2段階：有効期間フィルタの適用

### 処理概要

第2段階では、計測ログと有効期間テーブルをセンサナンバーで結合し、範囲フィルタを適用することで有効期間内の計測ログのみを抽出する。この処理により、各計測ログに正しいロット番号と有効期間が割り当てられる。

計測ログにはロット番号列が存在しないため、センサナンバーのみを結合キーとして使用する。同じセンサナンバーが複数のロットで使用されている場合、結合時に計測ログの各行は複数行に展開される。その後、created_atが有効開始以上かつ有効終了以下という範囲フィルタを適用することで、計測時刻が実際に含まれる有効期間の行のみを保持する。これにより、各計測ログに正しいロット番号が自動的に特定される。

### GUI操作手順

#### 前提：計測ログの列名変更

本処理を開始する前に、計測ログの列名を変更する必要がある。Link_計測ログクエリを選択した状態で、ホームタブのリボンから「詳細エディター」をクリックする。

エディターが開いたら、最後のステップ（`in`句の直前）に以下のコードを追加する。

```powerquery
    // 列名をリネーム
    列リネーム = Table.RenameColumns(
        前のステップ名,
        {
            {"field1(Temperature ºC)", "Temperature"},
            {"field2", "Humidity"}
        }
    )
```

「前のステップ名」の部分は、その時点での最後のステップの変数名に置き換える。例えば、最後のステップが「Source」という名前であれば、`Table.RenameColumns(Source, ...)`とする。

最後の`in`句の変数名を「列リネーム」に変更する。例えば、元々`in Source`となっていた場合、`in 列リネーム`に変更する。完了ボタンをクリックして変更を確定する。

#### ステップ2-1：センサーマスタとの結合

Link_計測ログクエリを選択した状態で、ホームタブのリボンから「クエリのマージ」をクリックする。

マージダイアログが表示されたら、上部のテーブルで「serial」列をクリックして選択する。下部のドロップダウンから「Link_センサーマスタ」テーブルを選択し、「センサーシリアル」列をクリックして選択する。結合の種類として「内部（両方のテーブルから一致する行のみ）」を選択し、OKをクリックする。

新しく追加された「Link_センサーマスタ」列の右側にある展開ボタンをクリックする。表示されるダイアログで、「センサナンバー」列のみにチェックを入れ、「元の列名をプレフィックスとして使用します」のチェックを外してOKをクリックする。これにより、計測ログの各行にセンサナンバーが追加される。

#### ステップ2-2：有効期間テーブルとの結合

再度、ホームタブから「クエリのマージ」をクリックする。今回は「センサナンバー」列のみを結合キーとして使用する。

マージダイアログが表示されたら、上部のテーブルで「センサナンバー」列をクリックして選択する。下部のドロップダウンから「Stg_有効期間」テーブルを選択し、「センサナンバー」列をクリックして選択する。

結合の種類として「左外部（最初（左）のテーブルのすべての行と、2番目（右）のテーブルの一致する行）」を選択し、OKをクリックする。左外部結合を選択することで、有効期間テーブルに存在しないセンサナンバーの計測ログも保持される。

新しく追加された「Stg_有効期間」列の展開ボタンをクリックする。表示されるダイアログで、「LOT」「有効開始」「有効終了」の3列すべてにチェックを入れる。「元の列名をプレフィックスとして使用します」のチェックを外してOKをクリックする。

展開後、同じセンサナンバーが複数のロットで使用されている場合、計測ログの1行が複数行に展開される。

#### ステップ2-3：有効期間内のフィルタ

Power QueryのGUIでは列同士の比較フィルタを直接設定できないため、詳細エディターを使用してMコードを編集する。

ホームタブのリボンから「詳細エディター」をクリックする。エディターが開いたら、最後のステップの後に以下のフィルタステップを追加する。

```powerquery
    // 有効期間内のフィルタ（閉区間: 両端を含む）
    フィルタ = Table.SelectRows(
        前のステップ名,
        each [created_at] >= [有効開始] and [created_at] <= [有効終了]
    )
```

「前のステップ名」の部分を実際の前ステップの変数名に置き換える。最後の`in`句の変数名を「フィルタ」に変更し、「完了」をクリックする。

これにより、各計測ログ行は、その計測時刻が含まれる有効期間のロットのみに絞り込まれる。結果として、各計測ログ行に正しいロット番号と有効期間が割り当てられる。

クエリ名を「有効期間フィルタ済み」など、わかりやすい名前に変更することを推奨する。

### 完了後の確認

有効期間フィルタ済みクエリのプレビューを確認する。以下の列が表示されていることを確認する必要がある。

created_at列はDateTime型で計測日時が格納されている。serial列はテキスト型でセンサーシリアル番号が格納されている。Temperature列は数値型で温度データが格納されている。Humidity列は数値型で湿度データが格納されている。センサナンバー列はテキスト型でセンサー番号が格納されている。LOT列はテキスト型でロット番号が格納されている。有効開始列はDateTime型で有効開始日時が格納されている。有効終了列はDateTime型で有効終了日時が格納されている。

各行において、created_atが有効開始以上かつ有効終了以下の範囲内に収まっていることを確認する。LOT列にnull値が存在しないことを確認する。もしnull値が存在する場合、有効期間テーブルに該当するセンサナンバーのデータが不足している可能性がある。

元の計測ログと比較して、有効期間外の行が適切に除外されていることを確認する。行数が大幅に減少している場合、有効期間の設定が正しいか、またはステータス2の行が適切に存在するかを確認する必要がある。

---

## 第3段階：FillDown処理による保管場所割当

### 処理概要

第3段階では、FillDown処理により計測ログと履歴表を時系列で統合し、各計測時刻における保管場所を特定する。この処理は、計測ログには保管場所情報が含まれていないため、履歴表の保管場所移動記録を利用して各計測時刻の保管場所を推定する仕組みである。

処理の流れは以下のとおりである。計測ログに保管場所列（NULL値）とレコード種別列（固定値「計測」）を追加する。履歴表からステータス0と1の行のみを抽出し、Temperature列とHumidity列（いずれもNULL値）とレコード種別列（固定値「履歴」）を追加し、日時列をcreated_atにリネームする。2つのテーブルを縦方向に統合する。センサナンバー、LOT、created_atの順序でソートする。保管場所列に対してFillDown操作を実行し、NULL値を直前の非NULL値で埋める。レコード種別が「計測」の行のみを抽出し、レコード種別列を削除する。

この処理により、履歴表の保管場所情報が計測ログの各行に時系列で割り当てられる。

### GUI操作手順

第3段階の処理は、Power QueryのGUI機能に制約があるため、詳細エディターでMコードを使用する方法を推奨する。以下に完全なMコード実装を示す。

#### Mコードによる実装

ホームタブのリボンから「新しいソース」→「空のクエリ」を選択する。新しく作成されたクエリの名前を「保管場所割当」に変更する。

クエリを選択した状態で、ホームタブのリボンから「詳細エディター」をクリックする。エディターに表示されているデフォルトのコードをすべて削除し、以下の完全なMコードをコピーして貼り付ける。

```powerquery
let
    // 第2段階完了時点のクエリを参照（クエリ名は環境に応じて変更）
    計測ログ = 有効期間フィルタ済み,
    履歴表 = Link_履歴表,
    
    // ステップ1: 計測ログに保管場所列とレコード種別列を追加
    計測ログ_保管場所列追加 = Table.AddColumn(計測ログ, "保管場所", each null, type text),
    計測ログ_レコード種別列追加 = Table.AddColumn(計測ログ_保管場所列追加, "レコード種別", each "計測", type text),
    
    // ステップ2: 履歴表のステータス0,1のみを抽出
    履歴表_フィルタ = Table.SelectRows(履歴表, each [ステータス] <> 2),
    
    // ステップ3: 履歴表にTemperature列、Humidity列、レコード種別列を追加
    履歴表_Temperature列追加 = Table.AddColumn(履歴表_フィルタ, "Temperature", each null, type number),
    履歴表_Humidity列追加 = Table.AddColumn(履歴表_Temperature列追加, "Humidity", each null, type number),
    履歴表_レコード種別列追加 = Table.AddColumn(履歴表_Humidity列追加, "レコード種別", each "履歴", type text),
    
    // ステップ4: 履歴表の日時列をcreated_atにリネーム
    履歴表_リネーム = Table.RenameColumns(履歴表_レコード種別列追加, {{"日時", "created_at"}}),
    
    // ステップ5: 2つのテーブルを縦に統合
    統合 = Table.Combine({計測ログ_レコード種別列追加, 履歴表_リネーム}),
    
    // ステップ6: センサナンバー×LOT×created_atでソート
    ソート = Table.Sort(統合, {
        {"センサナンバー", Order.Ascending},
        {"LOT", Order.Ascending},
        {"created_at", Order.Ascending}
    }),
    
    // ステップ7: 保管場所列をFillDown
    FillDown実行 = Table.FillDown(ソート, {"保管場所"}),
    
    // ステップ8: レコード種別="計測"の行のみを抽出
    計測のみ = Table.SelectRows(FillDown実行, each [レコード種別] = "計測"),
    
    // ステップ9: レコード種別列を削除
    列削除 = Table.RemoveColumns(計測のみ, {"レコード種別"})
in
    列削除
```

コードの2行目と3行目で参照しているクエリ名（「有効期間フィルタ済み」と「Link_履歴表」）を、実際の環境のクエリ名に合わせて修正する。第2段階完了時点のクエリ名が異なる場合は、適切なクエリ名に変更する。

完了ボタンをクリックする。構文エラーがないことを確認する。エラーが表示された場合は、参照しているクエリ名が正しいことを確認する。

### 完了後の確認

保管場所割当クエリのプレビューを確認する。以下の列が表示されていることを確認する必要がある。

created_at列はDateTime型で計測日時が格納されている。serial列はテキスト型でセンサーシリアル番号が格納されている。Temperature列は数値型で温度データが格納されており、null値が存在しないことを確認する。Humidity列は数値型で湿度データが格納されており、null値が存在しないことを確認する。センサナンバー列はテキスト型でセンサー番号が格納されている。LOT列はテキスト型でロット番号が格納されている。保管場所列はテキスト型で保管場所（エリア名）が格納されており、null値が存在しないことを確認する。有効開始列はDateTime型で有効開始日時が格納されている。有効終了列はDateTime型で有効終了日時が格納されている。

保管場所列にnull値が存在する場合、以下の原因が考えられる。履歴表にステータス0の行が不足している可能性がある。ソート順序が正しくない可能性がある。FillDown操作が正しく実行されていない可能性がある。

同じセンサナンバーとロット番号の組み合わせ内で、計測時刻に応じて保管場所が変化していることを確認する。例えば、エリアAからエリアCへの移動があった場合、移動時刻以降の計測ログ行にはエリアCが設定されているはずである。

データのサンプル例として、センサナンバー40、ロット番号Q25X231100、created_at 2025-10-23 18:10、保管場所エリアA、created_at 2025-10-23 19:30、保管場所エリアCのように、時系列で保管場所が変化している行が含まれているはずである。

---

## 第4段階：計算列の追加

### 処理概要

第4段階では、FillDown処理完了後のクエリに対して、工程区分列と絶対湿度列の2つの計算列を追加する。この処理により、最終的に「Cur_計測ログ_共通」という中間エンティティが作成される。

工程区分列は、ロット番号の先頭1文字から工程を判定する列である。Jで始まるロットはRT工程、KまたはGで始まるロットはRO工程、QまたはBで始まるロットはUF工程と判定される。この列は次の第5段階で工程別にテーブルを分割する際の判定基準として使用される。

絶対湿度列は、温度と相対湿度から絶対湿度を計算する列である。計算にはTetensの式を使用して飽和水蒸気圧を求め、相対湿度から実際の水蒸気圧を算出し、理想気体の状態方程式から絶対湿度を導出する。この列により、温湿度データをより詳細に分析することが可能になる。

### GUI操作手順

第4段階の処理は、詳細エディターでMコードを使用する方法を推奨する。以下に実装手順を示す。

#### Mコードによる実装

保管場所割当クエリを選択した状態で、ホームタブのリボンから「詳細エディター」をクリックする。エディターが開いたら、最後のステップ（`in`句の直前）に以下のコードを追加する。

```powerquery
    // 工程区分列を追加
    工程区分追加 = Table.AddColumn(
        列削除,
        "工程区分",
        each if Text.Start([LOT], 1) = "J" then "RT"
             else if Text.Start([LOT], 1) = "K" or Text.Start([LOT], 1) = "G" then "RO"
             else if Text.Start([LOT], 1) = "Q" or Text.Start([LOT], 1) = "B" then "UF"
             else null,
        type text
    ),
    
    // 絶対湿度列を追加
    絶対湿度追加 = Table.AddColumn(
        工程区分追加,
        "絶対湿度",
        each 
            let
                T = [Temperature],
                RH = [Humidity],
                // 飽和水蒸気圧の計算（Tetensの式）
                Psat = 6.1078 * Number.Power(10, (7.5 * T) / (T + 237.3)),
                // 実際の水蒸気圧
                Pv = Psat * (RH / 100),
                // 絶対湿度 [g/m³]
                AH = (2.16679 * Pv) / (T + 273.15)
            in
                AH,
        type number
    )
```

上記のコードにおいて、「列削除」という部分は、実際の前ステップの最終変数名に置き換える。最後の`in`句の変数名を「絶対湿度追加」に変更する。例えば、元々`in 列削除`となっていた場合、`in 絶対湿度追加`に変更する。

完了ボタンをクリックして変更を確定する。

クエリ名を「Cur_計測ログ_共通」に変更することを推奨する。これは、次の第5段階で工程別に分割する前の共通テーブルであることを示すためである。

### 完了後の確認

Cur_計測ログ_共通クエリのプレビューを確認する。以下の列が表示されていることを確認する必要がある。

created_at列、serial列、Temperature列、Humidity列、センサナンバー列、LOT列、保管場所列、有効開始列、有効終了列に加えて、工程区分列はテキスト型で工程名（RT、RO、UFのいずれか）が格納されている。絶対湿度列は数値型で絶対湿度の計算値が格納されている。

工程区分列の値を確認する。Jで始まるロット番号の行にはRTが設定されている。KまたはGで始まるロット番号の行にはROが設定されている。QまたはBで始まるロット番号の行にはUFが設定されている。上記のいずれにも該当しないロット番号の行にはnullが設定されている可能性がある。もしnullが存在する場合、そのロット番号の先頭文字が想定外の文字である可能性があるため、データを確認する必要がある。

絶対湿度列の値を確認する。計算結果が妥当な範囲（通常は5から30程度のグラム毎立方メートル）であることを確認する。もし異常に大きい値や小さい値、または負の値が存在する場合、温度または湿度のデータに異常がある可能性がある。絶対湿度の値が温度と湿度の変化に応じて変動していることを確認する。例えば、温度が高く湿度も高い場合、絶対湿度も高くなるはずである。

データのサンプル例として、LOT番号J25X250100、工程区分RT、Temperature 24.5、Humidity 45.0、絶対湿度約10.1のような行が含まれているはずである。

---

## 第5段階：工程別テーブルへの分割

### 処理概要

第5段階では、工程区分列の値に基づいてデータを分割し、RT工程用、RO工程用、UF工程用の3つのテーブルを作成する。これらのテーブルは最終的な出力エンティティとなる。

分割後は、各テーブルから工程区分列を削除する。この列は分割の判定基準として使用したものであり、分割後は各テーブル自体が特定の工程を表すため、列として保持する必要がなくなるためである。

### GUI操作手順

3つの新しいクエリを作成する必要がある。それぞれのクエリは、Cur_計測ログ_共通を参照し、特定の工程区分でフィルタした後、工程区分列を削除するという構成になる。

#### ステップ5-1：Cur_計測ログ_RTの作成

クエリペインでCur_計測ログ_共通クエリを右クリックし、「参照」を選択する。新しいクエリが作成されるため、クエリ名を「Cur_計測ログ_RT」に変更する。

詳細エディターを開き、以下のMコードに置き換える。

```powerquery
let
    Source = Cur_計測ログ_共通,
    フィルタ = Table.SelectRows(Source, each [工程区分] = "RT"),
    列削除 = Table.RemoveColumns(フィルタ, {"工程区分"})
in
    列削除
```

このコードは、工程区分がRTの行のみを抽出し、その後工程区分列を削除する。完了をクリックして変更を確定する。

プレビュー画面で、LOT列の値がすべてJで始まることを確認する。工程区分列が削除されていることを確認する。

#### ステップ5-2：Cur_計測ログ_ROの作成

クエリペインでCur_計測ログ_共通クエリを右クリックし、「参照」を選択する。新しいクエリが作成されるため、クエリ名を「Cur_計測ログ_RO」に変更する。

詳細エディターを開き、以下のMコードに置き換える。

```powerquery
let
    Source = Cur_計測ログ_共通,
    フィルタ = Table.SelectRows(Source, each [工程区分] = "RO"),
    列削除 = Table.RemoveColumns(フィルタ, {"工程区分"})
in
    列削除
```

完了をクリックして変更を確定する。

プレビュー画面で、LOT列の値がすべてKまたはGで始まることを確認する。工程区分列が削除されていることを確認する。

#### ステップ5-3：Cur_計測ログ_UFの作成

クエリペインでCur_計測ログ_共通クエリを右クリックし、「参照」を選択する。新しいクエリが作成されるため、クエリ名を「Cur_計測ログ_UF」に変更する。

詳細エディターを開き、以下のMコードに置き換える。

```powerquery
let
    Source = Cur_計測ログ_共通,
    フィルタ = Table.SelectRows(Source, each [工程区分] = "UF"),
    列削除 = Table.RemoveColumns(フィルタ, {"工程区分"})
in
    列削除
```

完了をクリックして変更を確定する。

プレビュー画面で、LOT列の値がすべてQまたはBで始まることを確認する。工程区分列が削除されていることを確認する。

### 完了後の確認

3つのテーブル（Cur_計測ログ_RT、Cur_計測ログ_RO、Cur_計測ログ_UF）のそれぞれについて、以下の点を確認する必要がある。

各テーブルに以下の列が含まれていることを確認する。created_at列、serial列、Temperature列、Humidity列、センサナンバー列、LOT列、保管場所列、有効開始列、有効終了列、絶対湿度列。

各テーブルに工程区分列が存在しないことを確認する。この列は削除されているはずである。

Cur_計測ログ_RTテーブルでは、LOT列の値がすべてJで始まることを確認する。Cur_計測ログ_ROテーブルでは、LOT列の値がすべてKまたはGで始まることを確認する。Cur_計測ログ_UFテーブルでは、LOT列の値がすべてQまたはBで始まることを確認する。

3つのテーブルの行数の合計が、Cur_計測ログ_共通テーブルの行数と一致することを確認する。もし一致しない場合、工程区分がnullの行が存在する可能性がある。

各テーブルにデータが存在することを確認する。もしいずれかのテーブルが空の場合、該当する工程のロット番号が元データに存在しない可能性がある。

データのサンプル例として、Cur_計測ログ_RTには LOT番号J25X250100のような行が、Cur_計測ログ_ROには LOT番号K25X240200のような行が、Cur_計測ログ_UFには LOT番号Q25X231100のような行が含まれているはずである。

---

## トラブルシューティング

本作業を実施する過程で発生する可能性のある問題とその解決策を以下に示す。

### 問題1：第1段階で有効期間テーブルの行数が予想より少ない

考えられる原因は、履歴表にステータス2の行が不足しているセンサナンバーとロット番号の組み合わせが存在する可能性である。ステータス0の行は存在するがステータス2の行が存在しない場合、内部結合により該当する行が除外される。

解決策として、履歴表を確認し、ステータス0とステータス2がペアで存在することを確認する。もしステータス2の行が不足している場合、データ提供元に確認して追加する必要がある。暫定的な対処として、結合の種類を「左外部」に変更し、有効終了がnullの行を許容することも可能だが、この場合は第2段階のフィルタ処理が正しく機能しない可能性がある。

### 問題2：第2段階でLOT列がnullになる行が存在する

考えられる原因は、有効期間テーブルに該当するセンサナンバーのデータが存在しない可能性である。計測ログのセンサナンバーが有効期間テーブルに存在しない場合、結合後にLOT列を含む有効期間情報がnullとなる。

解決策として、有効期間テーブルを確認し、計測ログに存在するすべてのセンサナンバーに対応する有効期間が定義されていることを確認する。もしセンサナンバーが不足している場合、履歴表にそのセンサナンバーのデータを追加する必要がある。

### 問題3：第3段階のFillDown後も保管場所がnullのまま

考えられる原因は、ソート順序が正しくない可能性、または履歴表の行が計測ログの行より後に配置されている可能性がある。FillDown操作は上から下に向かって順次実行されるため、履歴表の行が計測ログの行より後にある場合、保管場所の値が引き継がれない。

解決策として、ステップ6のソート操作を確認し、センサナンバー、LOT、created_atの順序で昇順にソートされていることを確認する。同じ時刻に履歴表と計測ログの行が存在する場合、履歴表の行が先に配置されていることを確認する。必要に応じて、レコード種別列をソート条件に追加し、履歴が計測より前に来るように調整する。

### 問題4：第4段階で絶対湿度の値が異常

考えられる原因は、温度または湿度のデータに異常値が含まれている可能性である。極端に高い温度や低い温度、100パーセントを超える湿度や負の湿度などが存在すると、絶対湿度の計算結果も異常になる。

解決策として、Temperature列とHumidity列のデータを確認し、妥当な範囲内の値であることを確認する。温度が摂氏マイナス50度から100度、湿度が0パーセントから100パーセントの範囲を超える値が存在する場合、データの精度を確認する必要がある。必要に応じて、異常値を除外するフィルタ処理を追加することを検討する。

### 問題5：第5段階でいずれかのテーブルが空になる

考えられる原因は、該当する工程のロット番号が元データに存在しない可能性である。例えば、すべてのロット番号がJで始まる場合、RT工程のテーブルにはデータが存在するが、RO工程とUF工程のテーブルは空になる。

解決策として、元の計測ログデータを確認し、すべての工程（RT、RO、UF）のロット番号が含まれていることを確認する。もし特定の工程のデータが不足している場合、データ提供元に確認する必要がある。また、第4段階で追加した工程区分列の判定ロジックが正しいことを確認する。ロット番号の先頭文字の判定条件が実際のデータと一致しているかを確認する。

### 問題6：処理時間が非常に長い

考えられる原因は、データ量が非常に多い場合、特にFillDown処理やソート処理に時間がかかる可能性がある。また、クエリの依存関係が複雑な場合、Power Queryが何度も同じ処理を実行している可能性がある。

解決策として、可能であればデータをサンプリングして処理時間を短縮することを検討する。例えば、特定の期間やセンサナンバーに限定してテストを行う。クエリの折りたたみ（Query Folding）が有効になっているか確認する。データソースがデータベースの場合、Power Queryがデータベース側で処理を実行できる場合がある。中間クエリで「読み込みを有効にする」のチェックを外すことで、不要なデータの読み込みを防ぐことができる。

---

## まとめ

本作業手順書では、計測ログデータに保管場所情報を付与し、工程別に分割されたテーブルを作成するまでの全5段階の処理を詳細に記載した。各段階の処理内容、GUI操作手順、完了後の確認方法を網羅しており、Power Queryの基本的な操作知識を持つ担当者であれば、本ドキュメントのみで作業を完遂できる構成となっている。

第1段階では履歴表から有効期間テーブルを作成し、第2段階では計測ログに正しいロット番号を割り当て、第3段階ではFillDown処理により保管場所を特定し、第4段階では工程区分と絶対湿度の計算列を追加し、第5段階では工程別にテーブルを分割した。

これらの処理により、元の計測ログデータには含まれていなかった保管場所情報が時系列で付与され、各工程に特化したテーブルが作成された。作成されたテーブル（Cur_計測ログ_RT、Cur_計測ログ_RO、Cur_計測ログ_UF）は、後続の分析処理やレポート作成に利用可能な形式となっている。

作業を実施する際は、各段階の完了後に必ず確認作業を実施し、想定通りのテーブル構造とデータが作成されていることを確認することが重要である。問題が発生した場合は、トラブルシューティングのセクションを参照し、適切な対処を行う必要がある。

本作業手順書は、担当者の引き継ぎ資料として、また運用マニュアルとして活用することができる。作業内容に変更が生じた場合は、本ドキュメントを更新し、最新の状態を維持することが推奨される。

---

*ドキュメントバージョン: 1.0*  
*作成日: 2025年12月12日*  
*最終更新日: 2025年12月12日*
