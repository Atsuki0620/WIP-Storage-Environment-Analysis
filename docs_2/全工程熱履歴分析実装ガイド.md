# 全工程熱履歴分析実装ガイド：生産直後と使用直前の影響検証

## 目次

1. [分析の背景と仮説](#分析の背景と仮説)
2. [時間窓の2つのタイプ](#時間窓の2つのタイプ)
3. [分析対象の全体像](#分析対象の全体像)
4. [データモデル設計](#データモデル設計)
5. [実装手順](#実装手順)
6. [集計可能ロット数の表示方法](#集計可能ロット数の表示方法)
7. [DAXメジャー設計](#daxメジャー設計)
8. [ビジュアル設計](#ビジュアル設計)
9. [実装チェックリスト](#実装チェックリスト)

---

## 分析の背景と仮説

製造工程において、中間品や原料の保管条件がその後の製品性能に与える影響を分析することは、品質管理と工程最適化の観点から極めて重要である。本プロジェクトでは、保管期間中の熱履歴が化学的性質や物理的特性に及ぼす影響について、2つの異なる時間的観点から検証を行う。

第一の仮説は、原料が生産された直後の熱履歴がその後の性質に影響を与えるというものである。具体的には、生産直後の高温環境が分子構造や結晶構造の形成に影響し、それが次工程での性能発現に寄与する可能性を想定している。この仮説では、保管開始時点からの初期6時間、12時間、24時間、48時間における平均温度を分析対象とする。

第二の仮説は、原料が次工程で使用される直前の熱履歴が性能に影響を与えるというものである。長期間保管された原料であっても、使用直前の保管状態が良好であれば高い性能を発現する可能性がある。この仮説では、保管終了時点から遡った直前6時間、12時間、24時間、48時間における平均温度を分析対象とする。

これらの仮説は、UF品からRO品への影響、RO品からRT品への影響、RT品から製品への影響、そしてRO品から製品への直接的な影響（RTスキップケース）のすべての工程間関係について検証される。

---

## 時間窓の2つのタイプ

本分析では、時間窓を2つの異なるタイプに分類して使用する。

### タイプA：生産直後時間窓

このタイプの時間窓は、保管開始時刻（ステータス0の日時）を起点として、そこから順方向に時間を計測する。例えば、保管開始から6時間後までの平均温度を算出する場合、保管開始時刻をゼロ点として、経過時間が0時間以上6時間未満の範囲で計測データを集計する。

生産直後時間窓では、原料が製造完了した直後の初期状態における熱履歴が、その後の化学反応や構造形成にどのように影響するかを検証する。短い時間窓ほど初期条件の影響が直接的に観測され、長い時間窓では保管場所の移動や外気温変動などの外乱要因が混入すると予測される。

### タイプB：使用直前時間窓

このタイプの時間窓は、保管終了時刻（ステータス2の日時）を起点として、そこから逆方向に時間を計測する。例えば、使用直前の6時間における平均温度を算出する場合、保管終了時刻をゼロ点として、保管終了時刻から遡って6時間前までの範囲で計測データを集計する。

使用直前時間窓では、原料が次工程で投入される直前の保管状態が、その原料を使用して製造される製品の性能にどのように影響するかを検証する。長期保管された原料であっても、使用直前の適切な温度管理により性能が維持または向上する可能性を検証する。

---

## 分析対象の全体像

本プロジェクトで分析する原料と製品の関係、および検証する仮説の組み合わせを以下に整理する。

### 分析対象1：UF品の熱履歴がRO品性能に与える影響

UF品を原料として使用し、RO品を製造する工程における熱履歴の影響を分析する。生産直後仮説では、UFロットの保管開始直後の温度がRO性能R、RO性能Fに影響を与えるかを検証する。使用直前仮説では、UFロットの保管終了直前の温度がRO性能R、RO性能Fに影響を与えるかを検証する。

この分析では、Cur_計測ログ_UFテーブルから各UFロットの時間窓別平均温度を算出し、それをCur_ロット系譜テーブルのRO性能R、RO性能Fと関連付けて散布図で可視化する。UFロット一つに対して複数のROロットが製造される一対多の関係を考慮する必要がある。

### 分析対象2：RO品の熱履歴がRT品性能に与える影響

RO品を原料として使用し、RT品を製造する工程における熱履歴の影響を分析する。生産直後仮説では、ROロットの保管開始直後の温度がRT性能R、RT性能Fに影響を与えるかを検証する。使用直前仮説では、ROロットの保管終了直前の温度がRT性能R、RT性能Fに影響を与えるかを検証する。

この分析は、時間窓分析実装ガイドで既に詳細に説明されている内容と同等であるが、使用直前時間窓の分析が追加される点が異なる。

### 分析対象3：RT品の熱履歴が製品性能に与える影響

RT品を原料として使用し、最終製品を製造する工程における熱履歴の影響を分析する。生産直後仮説では、RTロットの保管開始直後の温度が製品性能R、製品性能Fに影響を与えるかを検証する。使用直前仮説では、RTロットの保管終了直前の温度が製品性能R、製品性能Fに影響を与えるかを検証する。

RTロット一つに対して複数の製品ロットが製造される一対多の関係を考慮する必要がある。

### 分析対象4：RO品の熱履歴が製品性能に与える影響（RTスキップケース）

一部の製品品種では、RT工程を経由せずにRO品から直接製品を製造する。この場合、RO品を原料として使用し、最終製品を製造する工程における熱履歴の影響を分析する。生産直後仮説では、ROロットの保管開始直後の温度が製品性能R、製品性能Fに影響を与えるかを検証する。使用直前仮説では、ROロットの保管終了直前の温度が製品性能R、製品性能Fに影響を与えるかを検証する。

この分析対象は、Cur_ロット系譜テーブルにおいてRTロット列がNULLである製品ロットのみを対象とする。

---

## データモデル設計

全工程の熱履歴分析を実現するため、既存のデータモデルに対して大規模な拡張を行う必要がある。

### 拡張されるテーブル一覧

計測ログテーブルへの列追加として、Cur_計測ログ_UF、Cur_計測ログ_RO、Cur_計測ログ_RTのそれぞれに、保管開始時刻、経過時間_時間、保管終了時刻、終了前経過時間_時間の4列を追加する。

新規作成されるディメンションテーブルとして、Dim_時間窓マスタを作成する。このテーブルには時間窓ID、時間窓名、開始時間_相対、終了時間_相対、表示順序、時間窓タイプの6列を含む。

新規作成される計算テーブルとして、以下の6つのテーブルを作成する。Calc_UF保管統計_生産直後、Calc_UF保管統計_使用直前、Calc_RO保管統計_生産直後、Calc_RO保管統計_使用直前、Calc_RT保管統計_生産直後、Calc_RT保管統計_使用直前である。

### 計測ログテーブルの拡張構造

各計測ログテーブルに追加される列の詳細を以下に示す。

保管開始時刻列は、DateTime型であり、このロットの保管開始時刻（履歴表のステータス0の日時）を格納する。経過時間_時間列は、Number型であり、保管開始からの経過時間を時間単位で格納する。正の値を取り、保管開始時点で0となる。

保管終了時刻列は、DateTime型であり、このロットの保管終了時刻（履歴表のステータス2の日時）を格納する。終了前経過時間_時間列は、Number型であり、保管終了までの残り時間を時間単位で格納する。負の値を取り、保管終了時点で0となる。例えば、保管終了6時間前の計測データではマイナス6.0となる。

これらの列を使用することで、生産直後時間窓では経過時間_時間列を使用してフィルタリングし、使用直前時間窓では終了前経過時間_時間列を使用してフィルタリングすることが可能となる。

### Dim_時間窓マスタの構造

時間窓マスタテーブルは、生産直後と使用直前の両方のタイプを含む統合テーブルとして設計する。

テーブル構造は以下の通りである。時間窓ID列は、Integer型で主キーとなり、1から8までの値を取る。時間窓名列は、Text型で、生産直後0-6hr、生産直後0-12hr、生産直後0-24hr、生産直後0-48hr、使用直前6-0hr、使用直前12-0hr、使用直前24-0hr、使用直前48-0hrという値を取る。開始時間_相対列は、Number型であり、生産直後の場合は0、使用直前の場合はマイナス6、マイナス12、マイナス24、マイナス48という値を取る。終了時間_相対列は、Number型であり、生産直後の場合は6、12、24、48、使用直前の場合は0という値を取る。表示順序列は、Integer型で1から8までの値を取る。時間窓タイプ列は、Text型で、生産直後または使用直前という値を取る。

このテーブルの具体的なデータ例を示す。時間窓ID 1は、時間窓名が生産直後0-6hr、開始時間_相対が0、終了時間_相対が6、表示順序が1、時間窓タイプが生産直後である。時間窓ID 5は、時間窓名が使用直前6-0hr、開始時間_相対がマイナス6、終了時間_相対が0、表示順序が5、時間窓タイプが使用直前である。

### 計算テーブルの構造

各計算テーブル（例：Calc_UF保管統計_生産直後）は、以下の列を持つ。

ロット列は、Text型で、UFロット、ROロット、またはRTロットの番号を格納する。時間窓ID列は、Integer型で、Dim_時間窓マスタの時間窓IDを格納する。時間窓名列は、Text型で、時間窓の表示名を格納する。開始時間_相対列と終了時間_相対列は、Number型で、時間窓の範囲を格納する。平均温度列、平均湿度列、平均絶対湿度列は、Number型で、時間窓内の平均値を格納する。計測回数列は、Integer型で、時間窓内に存在する計測データの件数を格納する。

計測回数列は、集計可能ロット数を判定するための重要な指標となる。計測回数がゼロの場合、そのロットはその時間窓での集計が不可能であったことを意味する。例えば、保管期間が10時間しかないロットは、48時間の時間窓では計測回数がゼロとなる。

---

## 実装手順

実装は、計測ログテーブルへの列追加、時間窓マスタの作成、計算テーブルの作成、リレーションシップの構築という4つの段階で進める。

### 第1段階：計測ログテーブルへの列追加

既存のCur_計測ログ_UF、Cur_計測ログ_RO、Cur_計測ログ_RTのそれぞれに対して、4つの新規列を追加する作業を行う。以下では、Cur_計測ログ_UFを例に実装方法を説明するが、他のテーブルについても同様の処理を適用する。

Power Queryエディターで既存のCur_計測ログ_UFクエリを開き、最後のステップの後に以下の処理を追加する。

まず、履歴表からステータス0とステータス2の行を抽出し、保管開始時刻と保管終了時刻を取得する。履歴表全体からステータス0の行のみを選択し、必要な列であるセンサナンバー、LOT、日時を抽出する。日時列を保管開始時刻にリネームする。同様に、ステータス2の行のみを選択し、必要な列を抽出して、日時列を保管終了時刻にリネームする。

次に、計測ログテーブルと保管開始時刻テーブルをセンサナンバーとLOTをキーとして左外部結合し、保管開始時刻列を展開する。同様に、計測ログテーブルと保管終了時刻テーブルを左外部結合し、保管終了時刻列を展開する。

最後に、経過時間_時間列と終了前経過時間_時間列を計算する。経過時間_時間は、created_atから保管開始時刻を減算し、その結果をDuration.TotalHours関数で時間単位に変換する。終了前経過時間_時間は、created_atから保管終了時刻を減算し、その結果をDuration.TotalHours関数で時間単位に変換する。保管終了前の時刻では負の値となる。

Power Query Mコードの実装例を以下に示す。

```powerquery
let
    // 既存のクエリ結果
    既存クエリ = Cur_計測ログ_UF,
    
    // 保管開始時刻の取得
    履歴表 = Link_履歴表,
    保管開始 = Table.SelectRows(履歴表, each [ステータス] = 0),
    保管開始列 = Table.SelectColumns(保管開始, {"センサナンバー", "LOT", "日時"}),
    保管開始リネーム = Table.RenameColumns(保管開始列, {{"日時", "保管開始時刻"}}),
    
    // 保管終了時刻の取得
    保管終了 = Table.SelectRows(履歴表, each [ステータス] = 2),
    保管終了列 = Table.SelectColumns(保管終了, {"センサナンバー", "LOT", "日時"}),
    保管終了リネーム = Table.RenameColumns(保管終了列, {{"日時", "保管終了時刻"}}),
    
    // 保管開始時刻の結合
    開始結合 = Table.NestedJoin(
        既存クエリ,
        {"センサナンバー", "LOT"},
        保管開始リネーム,
        {"センサナンバー", "LOT"},
        "保管開始テーブル",
        JoinKind.LeftOuter
    ),
    開始展開 = Table.ExpandTableColumn(開始結合, "保管開始テーブル", {"保管開始時刻"}),
    
    // 保管終了時刻の結合
    終了結合 = Table.NestedJoin(
        開始展開,
        {"センサナンバー", "LOT"},
        保管終了リネーム,
        {"センサナンバー", "LOT"},
        "保管終了テーブル",
        JoinKind.LeftOuter
    ),
    終了展開 = Table.ExpandTableColumn(終了結合, "保管終了テーブル", {"保管終了時刻"}),
    
    // 経過時間の計算
    経過時間追加 = Table.AddColumn(
        終了展開,
        "経過時間_時間",
        each Duration.TotalHours([created_at] - [保管開始時刻]),
        type number
    ),
    
    // 終了前経過時間の計算
    終了前経過時間追加 = Table.AddColumn(
        経過時間追加,
        "終了前経過時間_時間",
        each Duration.TotalHours([created_at] - [保管終了時刻]),
        type number
    )
in
    終了前経過時間追加
```

この処理をCur_計測ログ_ROとCur_計測ログ_RTにも同様に適用する。

### 第2段階：Dim_時間窓マスタの作成

Power BIのモデリングビューで新しいテーブルを作成し、以下のDAX式を入力する。

```dax
Dim_時間窓マスタ = 
DATATABLE(
    "時間窓ID", INTEGER,
    "時間窓名", STRING,
    "開始時間_相対", INTEGER,
    "終了時間_相対", INTEGER,
    "表示順序", INTEGER,
    "時間窓タイプ", STRING,
    {
        {1, "生産直後0-6hr", 0, 6, 1, "生産直後"},
        {2, "生産直後0-12hr", 0, 12, 2, "生産直後"},
        {3, "生産直後0-24hr", 0, 24, 3, "生産直後"},
        {4, "生産直後0-48hr", 0, 48, 4, "生産直後"},
        {5, "使用直前6-0hr", -6, 0, 5, "使用直前"},
        {6, "使用直前12-0hr", -12, 0, 6, "使用直前"},
        {7, "使用直前24-0hr", -24, 0, 7, "使用直前"},
        {8, "使用直前48-0hr", -48, 0, 8, "使用直前"}
    }
)
```

このテーブルにより、生産直後と使用直前の両方のタイプの時間窓を統一的に管理できる。

### 第3段階：計算テーブルの作成

6つの計算テーブルを作成する必要があるが、構造は基本的に同一である。以下では、Calc_UF保管統計_生産直後を例に説明する。

Power BIのモデリングビューで新しいテーブルを作成し、以下のDAX式を入力する。

```dax
Calc_UF保管統計_生産直後 = 
VAR UFロット一覧 = 
    DISTINCT(SELECTCOLUMNS(
        Cur_ロット系譜,
        "UFロット", [UFロット]
    ))
VAR 時間窓一覧 = 
    CROSSJOIN(
        UFロット一覧,
        FILTER(Dim_時間窓マスタ, [時間窓タイプ] = "生産直後")
    )
VAR 統計テーブル = 
    ADDCOLUMNS(
        時間窓一覧,
        "平均温度", 
            VAR CurrentUF = [UFロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_UF[Temperature]),
                Cur_計測ログ_UF[LOT] = CurrentUF,
                Cur_計測ログ_UF[経過時間_時間] >= 開始,
                Cur_計測ログ_UF[経過時間_時間] < 終了
            ),
        "平均湿度",
            VAR CurrentUF = [UFロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_UF[Humidity]),
                Cur_計測ログ_UF[LOT] = CurrentUF,
                Cur_計測ログ_UF[経過時間_時間] >= 開始,
                Cur_計測ログ_UF[経過時間_時間] < 終了
            ),
        "平均絶対湿度",
            VAR CurrentUF = [UFロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_UF[絶対湿度]),
                Cur_計測ログ_UF[LOT] = CurrentUF,
                Cur_計測ログ_UF[経過時間_時間] >= 開始,
                Cur_計測ログ_UF[経過時間_時間] < 終了
            ),
        "計測回数",
            VAR CurrentUF = [UFロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                COUNTROWS(Cur_計測ログ_UF),
                Cur_計測ログ_UF[LOT] = CurrentUF,
                Cur_計測ログ_UF[経過時間_時間] >= 開始,
                Cur_計測ログ_UF[経過時間_時間] < 終了
            )
    )
RETURN
    統計テーブル
```

Calc_UF保管統計_使用直前については、経過時間_時間を終了前経過時間_時間に変更し、時間窓タイプのフィルタを使用直前に変更する以外は同じ構造である。

```dax
Calc_UF保管統計_使用直前 = 
VAR UFロット一覧 = 
    DISTINCT(SELECTCOLUMNS(
        Cur_ロット系譜,
        "UFロット", [UFロット]
    ))
VAR 時間窓一覧 = 
    CROSSJOIN(
        UFロット一覧,
        FILTER(Dim_時間窓マスタ, [時間窓タイプ] = "使用直前")
    )
VAR 統計テーブル = 
    ADDCOLUMNS(
        時間窓一覧,
        "平均温度", 
            VAR CurrentUF = [UFロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_UF[Temperature]),
                Cur_計測ログ_UF[LOT] = CurrentUF,
                Cur_計測ログ_UF[終了前経過時間_時間] >= 開始,
                Cur_計測ログ_UF[終了前経過時間_時間] < 終了
            ),
        "平均湿度",
            VAR CurrentUF = [UFロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_UF[Humidity]),
                Cur_計測ログ_UF[LOT] = CurrentUF,
                Cur_計測ログ_UF[終了前経過時間_時間] >= 開始,
                Cur_計測ログ_UF[終了前経過時間_時間] < 終了
            ),
        "平均絶対湿度",
            VAR CurrentUF = [UFロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                AVERAGE(Cur_計測ログ_UF[絶対湿度]),
                Cur_計測ログ_UF[LOT] = CurrentUF,
                Cur_計測ログ_UF[終了前経過時間_時間] >= 開始,
                Cur_計測ログ_UF[終了前経過時間_時間] < 終了
            ),
        "計測回数",
            VAR CurrentUF = [UFロット]
            VAR 開始 = [開始時間_相対]
            VAR 終了 = [終了時間_相対]
            RETURN
            CALCULATE(
                COUNTROWS(Cur_計測ログ_UF),
                Cur_計測ログ_UF[LOT] = CurrentUF,
                Cur_計測ログ_UF[終了前経過時間_時間] >= 開始,
                Cur_計測ログ_UF[終了前経過時間_時間] < 終了
            )
    )
RETURN
    統計テーブル
```

同様の方法で、Calc_RO保管統計_生産直後、Calc_RO保管統計_使用直前、Calc_RT保管統計_生産直後、Calc_RT保管統計_使用直前を作成する。ロット列の参照先とテーブル名を適切に変更すれば、DAX式の構造は同一である。

### 第4段階：リレーションシップの構築

作成した計算テーブルとその他のテーブルとの間にリレーションシップを構築する。

各計算テーブルとDim_時間窓マスタの間には、時間窓ID列を使用した一対多のリレーションシップを構築する。例えば、Dim_時間窓マスタの時間窓ID列からCalc_UF保管統計_生産直後の時間窓ID列への一対多のリレーションシップを作成する。クロスフィルタ方向は単一方向とする。

各計算テーブルとCur_ロット系譜の間には、ロット列を使用した多対多のリレーションシップを構築する。例えば、Calc_UF保管統計_生産直後のUFロット列とCur_ロット系譜のUFロット列との間に多対多のリレーションシップを作成する。クロスフィルタ方向は双方向とする。

この設定により、時間窓スライサーで特定の時間窓を選択すると、該当する計算テーブルのデータがフィルタされ、さらにCur_ロット系譜を通じて性能データと関連付けられる。

---

## 集計可能ロット数の表示方法

時間窓が長くなるほど、保管期間が短いロットは集計対象から外れるため、集計可能なロット数が減少する。この情報をレポートに表示することで、分析結果の信頼性を評価できる。

### 集計可能ロット数の定義

集計可能ロットとは、特定の時間窓において計測回数が1回以上存在するロットを指す。計測回数がゼロの場合、そのロットはその時間窓での平均温度を算出できないため、集計不可能と判断される。

例えば、保管期間が10時間のロットは、6時間と12時間の時間窓では集計可能であるが、24時間と48時間の時間窓では集計不可能となる。このため、48時間の時間窓で算出された平均温度は、長期保管されたロットのみを対象とした統計値となる。

### DAXメジャーによる実装

集計可能ロット数を算出するためのDAXメジャーを以下に示す。このメジャーは、計算テーブルにおいて計測回数が1以上の行の数をカウントする。

```dax
集計可能UFロット数_生産直後 = 
CALCULATE(
    DISTINCTCOUNT(Calc_UF保管統計_生産直後[UFロット]),
    Calc_UF保管統計_生産直後[計測回数] >= 1
)
```

同様に、各計算テーブルに対して集計可能ロット数メジャーを作成する。これらのメジャーは、マトリックスビジュアルやカードビジュアルで表示することで、ユーザーに分析対象のロット数を明示できる。

### 集計率の表示

集計可能ロット数に加えて、全ロット数に対する集計可能ロットの割合を表示することも有用である。以下のDAXメジャーは、集計率をパーセンテージで算出する。

```dax
集計率_生産直後 = 
VAR 集計可能数 = [集計可能UFロット数_生産直後]
VAR 全ロット数 = DISTINCTCOUNT(Cur_ロット系譜[UFロット])
RETURN
DIVIDE(集計可能数, 全ロット数, 0)
```

このメジャーを時間窓別に表示することで、時間窓の長さがサンプルサイズに与える影響を視覚的に理解できる。

---

## DAXメジャー設計

分析に必要な主要なDAXメジャーを工程別、仮説別に設計する。

### 分析対象1：UF品からRO品への影響

生産直後仮説の散布図用メジャーは以下の通りである。X軸には、Calc_UF保管統計_生産直後テーブルから取得した平均温度を使用する。Y軸には、Cur_ロット系譜テーブルからRO性能Fを使用する。

```dax
散布図_X軸_UF平均温度_生産直後 = 
SELECTEDVALUE(Calc_UF保管統計_生産直後[平均温度])

散布図_Y軸_RO性能F = 
AVERAGE(Cur_ロット系譜[RO性能F])
```

使用直前仮説の散布図用メジャーは、参照するテーブルを変更する以外は同じである。

```dax
散布図_X軸_UF平均温度_使用直前 = 
SELECTEDVALUE(Calc_UF保管統計_使用直前[平均温度])
```

相関分析メジャーとして、各時間窓における平均温度とRO性能Fの相関係数を算出する。

```dax
相関係数_UF温度_RO性能F_生産直後 = 
VAR データテーブル = 
    FILTER(
        CROSSJOIN(
            Calc_UF保管統計_生産直後,
            Cur_ロット系譜
        ),
        Calc_UF保管統計_生産直後[UFロット] = Cur_ロット系譜[UFロット]
            && NOT(ISBLANK(Calc_UF保管統計_生産直後[平均温度]))
            && NOT(ISBLANK(Cur_ロット系譜[RO性能F]))
    )
VAR N = COUNTROWS(データテーブル)
VAR SumX = SUMX(データテーブル, Calc_UF保管統計_生産直後[平均温度])
VAR SumY = SUMX(データテーブル, Cur_ロット系譜[RO性能F])
VAR SumXY = SUMX(データテーブル, Calc_UF保管統計_生産直後[平均温度] * Cur_ロット系譜[RO性能F])
VAR SumX2 = SUMX(データテーブル, POWER(Calc_UF保管統計_生産直後[平均温度], 2))
VAR SumY2 = SUMX(データテーブル, POWER(Cur_ロット系譜[RO性能F], 2))
VAR 分子 = N * SumXY - SumX * SumY
VAR 分母 = SQRT((N * SumX2 - POWER(SumX, 2)) * (N * SumY2 - POWER(SumY, 2)))
RETURN
    DIVIDE(分子, 分母)

決定係数R2_UF温度_RO性能F_生産直後 = 
POWER([相関係数_UF温度_RO性能F_生産直後], 2)
```

### 分析対象2：RO品からRT品への影響

RO品からRT品への影響分析は、時間窓分析実装ガイドで既に説明されている内容と同等である。生産直後仮説については、既存のメジャーをそのまま使用できる。使用直前仮説については、参照するテーブルをCalc_RO保管統計_使用直前に変更し、フィルタ列を終了前経過時間_時間に変更する。

### 分析対象3：RT品から製品への影響

RT品から製品への影響を分析するメジャーは、以下の通りである。

```dax
散布図_X軸_RT平均温度_生産直後 = 
SELECTEDVALUE(Calc_RT保管統計_生産直後[平均温度])

散布図_Y軸_製品性能F = 
AVERAGE(Cur_ロット系譜[性能F])

相関係数_RT温度_製品性能F_生産直後 = 
VAR データテーブル = 
    FILTER(
        CROSSJOIN(
            Calc_RT保管統計_生産直後,
            Cur_ロット系譜
        ),
        Calc_RT保管統計_生産直後[RTロット] = Cur_ロット系譜[RTロット]
            && NOT(ISBLANK(Calc_RT保管統計_生産直後[平均温度]))
            && NOT(ISBLANK(Cur_ロット系譜[性能F]))
    )
VAR N = COUNTROWS(データテーブル)
VAR SumX = SUMX(データテーブル, Calc_RT保管統計_生産直後[平均温度])
VAR SumY = SUMX(データテーブル, Cur_ロット系譜[性能F])
VAR SumXY = SUMX(データテーブル, Calc_RT保管統計_生産直後[平均温度] * Cur_ロット系譜[性能F])
VAR SumX2 = SUMX(データテーブル, POWER(Calc_RT保管統計_生産直後[平均温度], 2))
VAR SumY2 = SUMX(データテーブル, POWER(Cur_ロット系譜[性能F], 2))
VAR 分子 = N * SumXY - SumX * SumY
VAR 分母 = SQRT((N * SumX2 - POWER(SumX, 2)) * (N * SumY2 - POWER(SumY, 2)))
RETURN
    DIVIDE(分子, 分母)

決定係数R2_RT温度_製品性能F_生産直後 = 
POWER([相関係数_RT温度_製品性能F_生産直後], 2)
```

### 分析対象4：RO品から製品への影響（RTスキップケース）

RTスキップケースでは、RTロット列がNULLである製品ロットのみを分析対象とする必要がある。このため、相関分析メジャーにフィルタ条件を追加する。

```dax
相関係数_RO温度_製品性能F_生産直後_RTスキップ = 
VAR データテーブル = 
    FILTER(
        CROSSJOIN(
            Calc_RO保管統計_生産直後,
            Cur_ロット系譜
        ),
        Calc_RO保管統計_生産直後[ROロット] = Cur_ロット系譜[ROロット]
            && ISBLANK(Cur_ロット系譜[RTロット])
            && NOT(ISBLANK(Calc_RO保管統計_生産直後[平均温度]))
            && NOT(ISBLANK(Cur_ロット系譜[性能F]))
    )
VAR N = COUNTROWS(データテーブル)
VAR SumX = SUMX(データテーブル, Calc_RO保管統計_生産直後[平均温度])
VAR SumY = SUMX(データテーブル, Cur_ロット系譜[性能F])
VAR SumXY = SUMX(データテーブル, Calc_RO保管統計_生産直後[平均温度] * Cur_ロット系譜[性能F])
VAR SumX2 = SUMX(データテーブル, POWER(Calc_RO保管統計_生産直後[平均温度], 2))
VAR SumY2 = SUMX(データテーブル, POWER(Cur_ロット系譜[性能F], 2))
VAR 分子 = N * SumXY - SumX * SumY
VAR 分母 = SQRT((N * SumX2 - POWER(SumX, 2)) * (N * SumY2 - POWER(SumY, 2)))
RETURN
    DIVIDE(分子, 分母)
```

---

## ビジュアル設計

全工程の熱履歴分析を効果的に可視化するため、複数のレポートページを設計する。

### レポートページ1：分析対象選択ダッシュボード

このページは、ユーザーが分析したい工程間の関係と仮説タイプを選択するための入り口となる。4つの主要な分析対象（UF→RO、RO→RT、RT→製品、RO→製品）をボタンまたはカードで表示し、クリックすることで対応する詳細分析ページに遷移する仕組みを構築する。

各カードには、分析対象の名称、対象となる原料と製品の関係、現在の集計可能ロット数の概要を表示する。例えば、UF→RO分析のカードには、分析対象がUF品の熱履歴がRO品性能に与える影響であること、集計可能UFロット数が生産直後で45ロット、使用直前で40ロットであることを示す。

### レポートページ2：生産直後仮説検証（工程別）

各工程間関係について、生産直後の熱履歴と性能の相関を検証するページを作成する。例えば、RO→RT分析ページでは、以下のビジュアルを配置する。

散布図ビジュアルには、X軸にCalc_RO保管統計_生産直後の平均温度、Y軸にCur_ロット系譜のRT性能F、凡例にDim_時間窓マスタの時間窓名を設定する。詳細フィールドには、ROロットとRTロットの連結列を配置する。トレンドラインを追加し、決定係数R²を表示する。

時間窓別決定係数の縦棒グラフには、X軸にDim_時間窓マスタの時間窓名（生産直後タイプのみ）、Y軸に決定係数R2_RO温度_RT性能F_生産直後メジャーを設定する。このグラフにより、時間窓の長さと相関強度の関係を視覚的に確認できる。

集計可能ロット数のカードビジュアルには、集計可能ROロット数_生産直後メジャーを表示する。時間窓スライサーと連動して値が変化することで、サンプルサイズの変動を明示する。

スライサーとして、Dim_時間窓マスタの時間窓名（生産直後タイプのみ）を配置する。このスライサーで特定の時間窓を選択すると、散布図とカードが連動して更新される。

### レポートページ3：使用直前仮説検証（工程別）

生産直後仮説ページと同様の構成で、使用直前の熱履歴と性能の相関を検証するページを作成する。参照する計算テーブルをCalc_RO保管統計_使用直前に変更し、時間窓スライサーでは使用直前タイプのみを表示する。

散布図のX軸には使用直前の平均温度、凡例には使用直前6-0hr、使用直前12-0hr、使用直前24-0hr、使用直前48-0hrが表示される。

### レポートページ4：生産直後と使用直前の比較分析

同一の工程間関係について、生産直後仮説と使用直前仮説の決定係数を並べて比較するページを作成する。横軸に時間窓の長さ（6時間、12時間、24時間、48時間）、縦軸に決定係数R²を取った折れ線グラフを2本表示する。一本は生産直後仮説の決定係数、もう一本は使用直前仮説の決定係数である。

このグラフにより、どちらの仮説がより強い相関を示すか、また時間窓の長さによる相関強度の変化パターンが生産直後と使用直前で異なるかを比較検証できる。

### レポートページ5：全工程統合ビュー

すべての分析対象について、決定係数R²を一覧表示するマトリックスビジュアルを作成する。行に分析対象（UF→RO、RO→RT、RT→製品、RO→製品）、列に時間窓の種類（生産直後6時間、生産直後12時間、使用直前6時間、使用直前12時間など）を配置し、セルに決定係数R²を表示する。

条件付き書式を適用し、決定係数が高い（例：0.7以上）セルを緑色、中程度（例：0.4から0.7）を黄色、低い（例：0.4未満）を赤色で色分けする。これにより、どの工程間関係とどの時間窓の組み合わせで最も強い相関が観測されるかを一目で把握できる。

---

## 実装チェックリスト

全工程熱履歴分析の実装が正しく完了したことを確認するため、以下のチェックリストを使用する。

計測ログテーブルへの列追加について、Cur_計測ログ_UF、Cur_計測ログ_RO、Cur_計測ログ_RTのすべてに保管開始時刻列、経過時間_時間列、保管終了時刻列、終了前経過時間_時間列が追加されていることを確認する。経過時間_時間は保管開始時点でゼロ、保管中は正の値となることを確認する。終了前経過時間_時間は保管終了時点でゼロ、保管中は負の値となることを確認する。

Dim_時間窓マスタについて、8行のデータが正しく入力されていることを確認する。生産直後タイプが4行（0-6hr、0-12hr、0-24hr、0-48hr）、使用直前タイプが4行（6-0hr、12-0hr、24-0hr、48-0hr）であることを確認する。開始時間_相対と終了時間_相対の値が正しいことを確認する。

計算テーブルについて、6つのテーブル（Calc_UF保管統計_生産直後、Calc_UF保管統計_使用直前、Calc_RO保管統計_生産直後、Calc_RO保管統計_使用直前、Calc_RT保管統計_生産直後、Calc_RT保管統計_使用直前）がすべて作成されていることを確認する。各テーブルの行数がロット数×4（時間窓数）になっていることを確認する。平均温度、平均湿度、平均絶対湿度、計測回数の列が存在し、妥当な値が格納されていることを確認する。

リレーションシップについて、各計算テーブルとDim_時間窓マスタの間に時間窓ID列による一対多のリレーションシップが構築されていることを確認する。各計算テーブルとCur_ロット系譜の間にロット列による多対多のリレーションシップが構築されていることを確認する。多対多リレーションシップのクロスフィルタ方向が双方向に設定されていることを確認する。

DAXメジャーについて、各分析対象に対する散布図用メジャー、相関係数メジャー、決定係数メジャーが作成されていることを確認する。集計可能ロット数メジャーが各工程と仮説タイプに対して作成されていることを確認する。時間窓スライサーで特定の時間窓を選択した際に、メジャーの値が正しく更新されることを確認する。

ビジュアルについて、散布図にトレンドラインが表示され、決定係数R²が表示されることを確認する。時間窓スライサーで時間窓を切り替えると、散布図のプロット点と凡例が更新されることを確認する。集計可能ロット数カードが時間窓スライサーと連動して値が変化することを確認する。

---

## まとめ

本ドキュメントでは、全工程における熱履歴が製品性能に与える影響を、生産直後と使用直前という2つの時間的観点から分析するための完全な実装方法を説明した。

実装のポイントは、計測ログテーブルに保管開始時刻と保管終了時刻の両方を付与し、それぞれからの経過時間を計算することで、順方向と逆方向の両方の時間窓分析を可能にする点にある。Dim_時間窓マスタに時間窓タイプ列を追加することで、生産直後と使用直前の時間窓を統一的に管理できる。

計算テーブルを工程別かつ仮説別に分離することで、各分析対象に特化した統計値を事前計算し、ビジュアルのパフォーマンスを確保する。集計回数列を活用することで、時間窓の長さがサンプルサイズに与える影響を定量的に把握できる。

相関分析メジャーと決定係数メジャーを適切に設計することで、どの工程間関係において、どのタイプの熱履歴が最も強い影響を与えるかを科学的に検証できる。レポートページを分析対象別、仮説別に分割し、さらに統合ビューを提供することで、ユーザーは詳細分析と全体俯瞰の両方を柔軟に行うことができる。

これらの実装により、製造工程における熱履歴管理の最適化、品質予測モデルの構築、工程設計の改善といった実務上の意思決定を、データに基づいて行うことが可能となる。
