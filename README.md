# WIP-Storage-Environment-Analysis

保管場所（エリア）と時間帯に応じた保管環境の実態把握を行い、保管品の性能影響を分析するプロジェクト

## データ構成

```
data/
├── センサーマスタ.csv        # センサー情報マスタ
├── 履歴表.csv                # 保管場所の移動履歴
└── 計測ログ_*.csv           # センサー計測データ
```

## 履歴表と計測ログの突合（結合キー & JST）

### 結合キー

データの突合には以下の関係を利用します：

**センサーマスタ (`data/センサーマスタ.csv`)**
- `センサナンバー` ↔ `センサーシリアル` の対応関係を定義

**履歴表 (`data/履歴表.csv`)**
- `センサナンバー`, `LOT`, `保管場所`, `日時` を持つ
- 保管場所の移動履歴を記録

**計測ログ (`data/計測ログ_*.csv`)**
- `serial` (= センサーシリアル) を持つ
- センサーが記録した温湿度データ

**推奨の突合ルート**

1. **計測ログ `serial`** ↔ **センサーマスタ `センサーシリアル`** で `センサナンバー` を取得
2. 取得した **`センサナンバー`** で **履歴表** に接続
3. 計測ログの時刻で保管場所（エリア）を割り当て

### 時刻の扱い（JST）

**計測ログの `created_at`**
- ISO 8601形式（`+09:00` を含む）が想定される
- **timezone-aware（JST）** として扱う
- 例: `2025-10-11T10:20:22+09:00`

**履歴表の `日時`**
- 文字列形式の可能性が高い（例: `2025/9/18 8:10`）
- 読み込み時に **JST として解釈** し、比較可能な datetime に揃える
- この列は「保管場所が切り替わった時刻」を表す

**時刻区間の構成（区間JOIN）**

履歴表の `日時` から **滞在区間（開始〜次の開始直前）** を構成し、その区間に含まれる計測ログを当てます。

**区間境界のルール**
- `日時` は区間の **開始（inclusive）**
- 次区間の開始は **exclusive**（`[start, next_start)` の半開区間）
- 例:
  ```
  センサナンバー40の履歴:
  - エリアA: 2025/9/18 8:10 ～ 2025/9/18 11:25（次の開始直前まで）
  - エリアC: 2025/9/18 11:25 ～ 2025/9/18 14:40
  - エリアB: 2025/9/18 14:40 ～ 2025/9/19 9:05
  ...
  ```

計測ログの `created_at` が上記区間のどこに含まれるかで、その時点の保管場所を特定できます。

### 実装時の注意点

- pandas で時刻比較を行う場合、`pd.to_datetime()` でJSTに揃えること
- 区間JOINには `pd.merge_asof()` や条件付きJOINが有効
- 最後の履歴行（次がない場合）の扱いを明確にすること（例: 無限大まで、またはログの最終時刻まで）

## セットアップ

```bash
pip install -r requirements.txt
```

## データ検証

```bash
python scripts/validate_data.py
```
